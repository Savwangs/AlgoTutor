<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AlgoTutor</title>
    <script type="oas-config">
      {
        "state": {
          "toolOutput": { "type": "json" }
        }
      }
    </script>
    <style>
      :root {
        color-scheme: light dark;
        --bg-main: #0a0e27;
        --bg-panel: #0f1629;
        --bg-editor: #0a0e27;
        --bg-output: #0a0e27;
        --border-subtle: #1f2937;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.16);
        --accent-strong: rgba(59, 130, 246, 0.9);
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --text-strong: #f9fafb;
        --badge-bg: #1e293b;
        --badge-accent-bg: #1e40af;
        --error: #ef4444;
        --success: #10b981;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro",
          "Inter", sans-serif;
      }

      html,
      body {
        width: 100%;
        min-height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0a0e27 0%, #1e293b 100%);
        padding: 12px;
        color: var(--text-main);
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        border-radius: 16px;
        background: var(--bg-panel);
        border: 1px solid var(--border-subtle);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
        background: linear-gradient(
          to right,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.05)
        );
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-strong);
        background: linear-gradient(to right, #3b82f6, #60a5fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .tagline {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .mode-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 4px;
      }

      .mode-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s;
      }

      .mode-btn:hover {
        border-color: var(--accent);
        color: var(--text-strong);
      }

      .mode-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1.5fr);
        gap: 0;
        min-height: 500px;
      }

      /* Left pane (inputs) */
      .pane-left {
        border-right: 1px solid var(--border-subtle);
        background: var(--bg-editor);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        overflow-y: auto;
      }

      .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-strong);
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
        display: block;
        margin-bottom: 6px;
      }

      .field-block {
        display: flex;
        flex-direction: column;
      }

      textarea,
      select,
      input[type="text"] {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        padding: 10px 12px;
        font-size: 0.85rem;
        box-sizing: border-box;
        background-color: #0a0e27;
        color: var(--text-main);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      textarea:focus,
      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      }

      select {
        font-family: system-ui, sans-serif;
        background-color: #0a0e27;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row > div {
        flex: 1;
      }

      .toggles-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        border-radius: 8px;
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .toggle-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .toggle-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent);
      }

      .toggle-item label {
        margin: 0;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--text-main);
      }

      .hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin: 4px 0 0 0;
      }

      .submit-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border-subtle);
      }

      button.primary {
        border: none;
        border-radius: 8px;
        background: linear-gradient(to right, var(--accent-strong), #60a5fa);
        color: white;
        font-weight: 600;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        transition: all 0.2s;
      }

      button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
      }

      button.primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status {
        font-size: 0.8rem;
        color: var(--text-muted);
        padding: 8px;
        border-radius: 6px;
        background: rgba(15, 23, 42, 0.5);
      }

      /* Right pane (output) */
      .pane-right {
        background: var(--bg-output);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .output-block {
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        background: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.8),
          rgba(15, 23, 42, 0.6)
        );
        padding: 14px;
      }

      .output-block h3 {
        margin: 0 0 10px 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .output-block h3::before {
        content: "‚ñ∏";
        font-size: 1rem;
      }

      .output-content {
        font-size: 0.85rem;
        line-height: 1.6;
        color: var(--text-main);
      }

      .output-empty {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
        text-align: center;
        padding: 40px 20px;
      }

      .code-block {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: #0a0e27;
        color: #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid var(--border-subtle);
        margin-top: 8px;
        overflow-x: auto;
      }

      /* Code block wrapper for copy button */
      .code-block-copy-wrapper {
        position: relative;
      }

      .copy-code-btn {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 6px;
        color: var(--text-muted);
        font-size: 0.7rem;
        padding: 4px 10px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
        z-index: 2;
      }

      .copy-code-btn:hover {
        background: rgba(59, 130, 246, 0.3);
        color: var(--text-strong);
        border-color: var(--accent);
      }

      .copy-code-btn.copied {
        background: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.4);
        color: var(--success);
      }

      /* Text block for walkthroughs and explanations - improved readability */
      .text-block {
        font-size: 0.88rem;
        line-height: 1.9;
        color: var(--text-main);
        padding: 8px 0;
      }

      .text-block br {
        display: block;
        content: "";
        margin-top: 6px;
      }

      .table-wrapper {
        overflow-x: auto;
        margin-top: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }

      table th,
      table td {
        padding: 8px;
        text-align: left;
        border: 1px solid var(--border-subtle);
      }

      table th {
        background: rgba(59, 130, 246, 0.2);
        color: var(--text-strong);
        font-weight: 600;
      }

      table td {
        background: rgba(15, 23, 42, 0.5);
      }

      .list-block {
        margin: 8px 0;
        padding-left: 20px;
      }

      .list-block li {
        margin: 6px 0;
        line-height: 1.5;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
        background: var(--badge-accent-bg);
        color: white;
        margin-right: 6px;
      }

      .error-text {
        color: var(--error);
        font-weight: 500;
      }

      .success-text {
        color: var(--success);
        font-weight: 500;
      }

      /* Trick/Shortcut Callout Boxes - Top of output */
      .trick-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 20px;
      }

      .trick-box.build {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #3b82f6;
      }

      .trick-box.debug {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #ef4444;
      }

      .trick-box-title {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #92400e;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .trick-box-title::before {
        content: "üí°";
        font-size: 1.1rem;
      }

      .trick-box.build .trick-box-title {
        color: #1e40af;
      }

      .trick-box.build .trick-box-title::before {
        content: "üèπüéØ";
      }

      .trick-box.debug .trick-box-title {
        color: #991b1b;
      }

      .trick-box.debug .trick-box-title::before {
        content: "üîç";
      }

      .trick-box-content {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        line-height: 1.5;
      }

      /* Don't Forget / What Profs Test Warning Box */
      .warning-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-left-width: 4px;
        border-radius: 8px;
        padding: 14px 16px;
        margin-top: 16px;
        margin-bottom: 12px;
      }

      .warning-box-title {
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #92400e;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .warning-box-title::before {
        content: "‚ö†Ô∏è";
      }

      .warning-box-content {
        font-size: 0.9rem;
        color: #1f2937;
        line-height: 1.5;
      }

      /* Pattern Signature Keywords */
      .pattern-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .keyword-tag {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      /* Exact Bug Line Highlight */
      .bug-line-box {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
      }

      .bug-line-number {
        font-weight: 700;
        color: #ef4444;
        font-size: 0.9rem;
      }

      .bug-line-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        background: #1f2937;
        color: #fca5a5;
        padding: 8px 12px;
        border-radius: 6px;
        margin: 8px 0;
        font-size: 0.85rem;
        overflow-x: auto;
      }

      .bug-line-issue {
        font-size: 0.85rem;
        color: var(--text-main);
      }

      /* Fill-in-Blank Answers */
      .blank-answer {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
      }

      .blank-answer-label {
        font-weight: 600;
        color: #10b981;
        font-size: 0.85rem;
        margin-bottom: 4px;
      }

      .blank-answer-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        background: #1f2937;
        color: #6ee7b7;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
        display: inline-block;
        margin: 4px 0;
      }

      .blank-answer-reason {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 6px;
        font-style: italic;
      }

      /* If On Exam Box */
      .exam-tip-box {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        padding: 12px 14px;
        margin-top: 12px;
      }

      .exam-tip-title {
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #8b5cf6;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .exam-tip-title::before {
        content: "üìù";
      }

      .exam-tip-content {
        font-size: 0.85rem;
        color: var(--text-main);
        line-height: 1.5;
      }

      /* Upgrade button styles */
      .upgrade-container {
        text-align: center;
        padding: 40px 20px;
      }

      .upgrade-message {
        font-size: 1.1rem;
        color: var(--error);
        margin-bottom: 20px;
      }

      .upgrade-btn {
        display: inline-block;
        padding: 14px 28px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
      }

      .upgrade-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
      }

      /* EARLY_ACCESS: Early Access Banner */
      .early-access-banner {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.15));
        border: 1px solid rgba(16, 185, 129, 0.4);
        border-radius: 8px;
        padding: 10px 16px;
        margin-bottom: 12px;
        text-align: center;
      }

      .early-access-banner-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #10b981;
        margin-bottom: 4px;
      }

      .early-access-banner-text {
        font-size: 0.8rem;
        color: var(--text-main);
        line-height: 1.4;
      }

      .early-access-banner-text strong {
        color: #fbbf24;
      }

      /* Early adopter promo banner */
      .promo-banner {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.1));
        border: 1px solid rgba(245, 158, 11, 0.4);
        border-radius: 10px;
        padding: 16px;
        margin-top: 20px;
        text-align: left;
      }

      .promo-banner-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #fbbf24;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .promo-banner-text {
        font-size: 0.85rem;
        color: var(--text-main);
        line-height: 1.6;
        margin: 0;
      }

      .promo-banner-text strong {
        color: #fbbf24;
      }

      /* Validation error display */
      .validation-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
      }

      .validation-error-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }

      .validation-error-text {
        font-size: 1rem;
        color: var(--error);
        font-weight: 500;
        line-height: 1.6;
      }

      /* Premium activation button in header */
      .activate-premium-btn {
        padding: 8px 14px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .activate-premium-btn:hover {
        transform: scale(1.05);
      }

      /* Header buttons container */
      .header-buttons {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* Help link */
      .help-link {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 0.75rem;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }

      .help-link:hover {
        color: var(--accent);
        background: rgba(59, 130, 246, 0.1);
      }

      /* Cancel subscription button */
      .cancel-subscription-btn {
        padding: 6px 10px;
        background: transparent;
        color: var(--text-muted);
        font-size: 0.75rem;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: none;
      }

      .cancel-subscription-btn:hover {
        color: var(--error);
        border-color: var(--error);
      }

      /* Modal styles */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg-panel);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }

      .modal h2 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--text-strong);
      }

      .modal p {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .modal-input {
        width: 100%;
        padding: 12px;
        background: var(--bg-editor);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-main);
        font-size: 1.1rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-align: center;
        margin-bottom: 1rem;
      }

      .modal-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
      }

      .modal-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .modal-btn-primary:hover {
        transform: translateY(-1px);
      }

      .modal-btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .modal-btn-secondary {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
      }

      .modal-btn-secondary:hover {
        border-color: var(--text-muted);
      }

      .modal-message {
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: center;
      }

      .modal-message.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid var(--success);
      }

      .modal-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
        border: 1px solid var(--error);
      }

      /* Mode-specific visibility */
      .mode-content {
        display: none;
      }

      .mode-content.active {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* Premium success state */
      .premium-success-container {
        text-align: center;
        padding: 60px 20px;
      }

      .premium-success-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      .premium-success-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--success);
        margin-bottom: 12px;
      }

      .premium-success-message {
        font-size: 1rem;
        color: var(--text-main);
        margin-bottom: 8px;
        line-height: 1.6;
      }

      .premium-success-hint {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 20px;
        padding: 12px 16px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        display: inline-block;
      }

      /* Feedback UI Styles */
      .feedback-container {
        margin-top: 24px;
        padding: 16px;
        border-top: 1px solid var(--border-subtle);
        text-align: center;
      }

      .feedback-prompt {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 12px;
      }

      .feedback-btn {
        padding: 8px 16px;
        margin: 0 8px;
        font-size: 1.2rem;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .feedback-btn:hover {
        background: var(--bg-hover);
        transform: scale(1.1);
      }

      .feedback-btn.selected {
        background: var(--accent-green);
        border-color: var(--accent-green);
      }

      .feedback-thanks {
        color: var(--accent-green);
        font-size: 0.9rem;
        padding: 8px;
      }

      /* Feedback Modal Styles */
      .feedback-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .feedback-modal-overlay.active {
        display: flex;
      }

      .feedback-modal {
        background: var(--bg-main);
        border: 1px solid var(--border-main);
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      }

      .feedback-modal h3 {
        margin: 0 0 16px 0;
        color: var(--text-main);
        font-size: 1.1rem;
        text-align: center;
      }

      .feedback-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }

      .feedback-option-btn {
        padding: 12px 16px;
        background: var(--bg-block);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-main);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
      }

      .feedback-option-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-blue);
      }

      .feedback-modal-skip {
        width: 100%;
        padding: 10px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-muted);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .feedback-modal-skip:hover {
        color: var(--text-main);
        border-color: var(--border-main);
      }

      /* Follow-up Question Buttons (Learn Mode) */
      .followup-buttons-container {
        margin-top: 24px;
        padding: 16px;
        border-top: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .followup-buttons-title {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 8px;
        text-align: center;
      }

      .followup-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 10px;
        color: var(--text-main);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
      }

      .followup-btn:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
        border-color: var(--accent);
        transform: translateX(4px);
      }

      .followup-btn-icon {
        font-size: 1.4rem;
        flex-shrink: 0;
      }

      .followup-btn-text {
        flex: 1;
      }

      .followup-btn-arrow {
        color: var(--accent);
        font-size: 1.2rem;
      }

      /* Fill-in-the-Blank Interactive UI */
      .fillin-container {
        background: var(--bg-panel);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 20px;
        margin-top: 16px;
      }

      .fillin-problem-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-strong);
        margin-bottom: 12px;
      }

      .fillin-problem-description {
        font-size: 0.9rem;
        color: var(--text-main);
        line-height: 1.6;
        margin-bottom: 16px;
        padding: 12px;
        background: rgba(59, 130, 246, 0.05);
        border-radius: 8px;
        border-left: 3px solid var(--accent);
      }

      .fillin-testcases {
        margin-bottom: 16px;
      }

      .fillin-testcases-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .fillin-testcase {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.8rem;
        padding: 8px 12px;
        background: #0a0e27;
        border-radius: 6px;
        margin-bottom: 6px;
        border: 1px solid var(--border-subtle);
      }

      .fillin-testcase-input {
        color: #60a5fa;
      }

      .fillin-testcase-output {
        color: #10b981;
      }

      .fillin-code-container {
        margin-bottom: 20px;
      }

      .fillin-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.85rem;
        background: #0a0e27;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid var(--border-subtle);
        overflow-x: auto;
        white-space: pre;
        line-height: 1.6;
      }

      .fillin-blanks-section {
        margin-top: 20px;
      }

      .fillin-blanks-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-strong);
        margin-bottom: 16px;
      }

      .fillin-blank-item {
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid var(--border-subtle);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .fillin-blank-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .fillin-blank-context {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 12px;
        padding: 8px;
        background: #0a0e27;
        border-radius: 4px;
      }

      .fillin-input-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .fillin-select {
        flex: 1;
        padding: 10px 12px;
        background: #0a0e27;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        color: var(--text-main);
        font-size: 0.9rem;
        cursor: pointer;
      }

      .fillin-select:focus {
        outline: none;
        border-color: var(--accent);
      }

      .fillin-text-input {
        flex: 1;
        padding: 10px 12px;
        background: #0a0e27;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        color: var(--text-main);
        font-size: 0.9rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      }

      .fillin-text-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .fillin-check-btn {
        padding: 10px 16px;
        background: var(--accent);
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .fillin-check-btn:hover {
        background: #2563eb;
      }

      .fillin-check-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .fillin-feedback {
        margin-top: 10px;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 0.85rem;
        display: none;
      }

      .fillin-feedback.correct {
        display: block;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: #10b981;
      }

      .fillin-feedback.incorrect {
        display: block;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
      }

      .fillin-hint-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: pointer;
        padding: 4px 8px;
        margin-left: 8px;
      }

      .fillin-hint-btn:hover {
        color: var(--accent);
      }

      .fillin-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-style: italic;
        margin-top: 8px;
        display: none;
      }

      .fillin-hint-feedback {
        font-size: 0.85rem;
        color: #fbbf24;
        margin-top: 6px;
        font-style: italic;
      }

      .fillin-tries-left {
        font-size: 0.85rem;
        color: #f97316;
        font-weight: 500;
      }

      .fillin-answer-reveal {
        margin-top: 10px;
        padding: 10px 14px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        font-family: 'JetBrains Mono', monospace;
      }
      
      .fillin-answer-reveal code {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 4px;
        color: #f87171;
      }

      .fillin-review-tip {
        margin-top: 12px;
        padding: 10px 14px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        font-size: 0.9rem;
        color: #93c5fd;
        line-height: 1.4;
      }

      .fillin-hint.visible {
        display: block;
      }

      .fillin-explanation {
        margin-top: 8px;
        font-size: 0.85rem;
        color: var(--text-main);
        line-height: 1.5;
      }

      .fillin-why-tests {
        margin-top: 20px;
        padding: 14px;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
      }

      .fillin-why-tests-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: #8b5cf6;
        margin-bottom: 6px;
        text-transform: uppercase;
      }

      .fillin-why-tests-text {
        font-size: 0.85rem;
        color: var(--text-main);
      }

      /* AI Recommendation Button and Display */
      .ai-recommendation-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
        padding: 10px 20px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(59, 130, 246, 0.2));
        border: 1px solid rgba(168, 85, 247, 0.4);
        border-radius: 10px;
        color: #c084fc;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-recommendation-btn:hover {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.35), rgba(59, 130, 246, 0.35));
        border-color: rgba(168, 85, 247, 0.6);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
      }

      .ai-recommendation-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .ai-recommendation-btn .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(168, 85, 247, 0.3);
        border-top-color: #c084fc;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .ai-recommendation-container {
        margin-top: 16px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(59, 130, 246, 0.08));
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: 12px;
      }

      .ai-recommendation-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #c084fc;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .ai-recommendation-section {
        margin-bottom: 14px;
      }

      .ai-recommendation-section:last-child {
        margin-bottom: 0;
      }

      .ai-recommendation-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-strong);
        margin-bottom: 6px;
      }

      .ai-recommendation-section-content {
        font-size: 0.83rem;
        line-height: 1.7;
        color: var(--text-main);
      }

      .ai-recommendation-section-content ul {
        margin: 4px 0;
        padding-left: 18px;
      }

      .ai-recommendation-section-content li {
        margin: 4px 0;
      }

      /* Trace Table and Walkthrough Specific Styles */
      .trace-walkthrough-container {
        padding: 16px;
      }

      .example-io {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .example-io-item {
        flex: 1;
        min-width: 200px;
        padding: 12px;
        background: rgba(59, 130, 246, 0.05);
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
      }

      .example-io-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
      }

      .example-io-value {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.9rem;
        color: var(--text-strong);
      }
    </style>
  </head>

  <body>
    <main>
      <header>
        <div class="header-top">
          <div>
            <h1>üöÄ AlgoTutor</h1>
            <p class="tagline">
              Exam Cheat Code Edition: Pattern recognition, paper-friendly code,
              and the tricks professors test
            </p>
          </div>
          <div class="header-buttons">
            <button class="help-link" id="help-btn" title="Contact support">
              Need Help?
            </button>
            <!-- EARLY_ACCESS_START: Premium buttons hidden during early access
            <button class="cancel-subscription-btn" id="cancel-subscription-btn">
              Cancel Subscription
            </button>
            <button class="activate-premium-btn" id="activate-premium-btn">
              ‚ö° Activate Premium
            </button>
            EARLY_ACCESS_END -->
          </div>
        </div>
        <div class="mode-selector">
          <button class="mode-btn active" data-mode="learn">
            üìö Learn Mode
          </button>
          <button class="mode-btn" data-mode="build">üî® Build Mode</button>
          <button class="mode-btn" data-mode="debug">üêõ Debug Mode</button>
        </div>
      </header>

      <div class="layout">
        <!-- LEFT PANE: Inputs -->
        <section class="pane-left">
          <!-- LEARN MODE -->
          <form id="learn-form" class="mode-content active">
            <h2 class="section-title">Learn Mode</h2>

            <div class="field-block">
              <label for="learn-topic">Pattern / Topic</label>
              <input
                type="text"
                id="learn-topic"
                placeholder="e.g., BFS, two pointers, sliding window, DFS, merge sort"
              />
            </div>

            <div class="row">
              <div class="field-block">
                <label for="learn-difficulty">Difficulty</label>
                <select id="learn-difficulty">
                  <option value="basic">Basic</option>
                  <option value="normal" selected>Normal</option>
                  <option value="dumb-it-down">Dumb-It-Down</option>
                </select>
              </div>
              <div class="field-block">
                <label for="learn-depth">Depth</label>
                <select id="learn-depth">
                  <option value="tiny">Tiny (5 steps)</option>
                  <option value="normal" selected>Normal</option>
                  <option value="full">Full Walkthrough</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field-block">
                <label for="learn-example-size">Example Size</label>
                <select id="learn-example-size">
                  <option value="small" selected>Small</option>
                  <option value="medium">Medium</option>
                </select>
              </div>
            </div>

            <div class="submit-section">
              <button type="submit" class="primary">
                <span>üìö</span>
                <span>Learn This Topic</span>
              </button>
              <div class="status" id="learn-status">
                Ready. Enter a topic to learn.
              </div>
            </div>
          </form>

          <!-- BUILD MODE -->
          <form id="build-form" class="mode-content">
            <h2 class="section-title">Build Mode</h2>

            <div class="field-block">
              <label for="build-problem">Problem Description</label>
              <textarea
                id="build-problem"
                placeholder="Paste your coding problem here..."
              ></textarea>
            </div>

            <div class="row">
              <div class="field-block">
                <label for="build-language">Language</label>
                <select id="build-language">
                  <option value="python" selected>Python</option>
                  <option value="java">Java</option>
                  <option value="cpp">C++</option>
                </select>
              </div>
            </div>

            <div class="toggles-section">
              <div class="toggle-item">
                <input type="checkbox" id="build-recursion" />
                <label for="build-recursion">Allow recursion</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="build-minimal-code" checked />
                <label for="build-minimal-code">Minimal code style</label>
              </div>
            </div>

            <div class="submit-section">
              <button type="submit" class="primary">
                <span>üî®</span>
                <span>Build Solution</span>
              </button>
              <div class="status" id="build-status">
                Ready. Enter a problem to solve.
              </div>
            </div>
          </form>

          <!-- DEBUG MODE -->
          <form id="debug-form" class="mode-content">
            <h2 class="section-title">Debug Mode</h2>

            <div class="field-block">
              <label for="debug-code">Code Snippet</label>
              <textarea
                id="debug-code"
                placeholder="Paste your code here to debug..."
              ></textarea>
            </div>

            <div class="row">
              <div class="field-block">
                <label for="debug-language">Language</label>
                <select id="debug-language">
                  <option value="python" selected>Python</option>
                  <option value="java">Java</option>
                  <option value="cpp">C++</option>
                </select>
              </div>
            </div>

            <div class="submit-section">
              <button type="submit" class="primary">
                <span>üêõ</span>
                <span>Debug This Code</span>
              </button>
              <div class="status" id="debug-status">
                Ready. Paste your code to debug.
              </div>
            </div>
          </form>
        </section>

        <!-- RIGHT PANE: Outputs -->
        <section class="pane-right" id="output-container">
          <div class="output-empty">
            Select a mode on the left, fill in the details, and submit.<br />
            All explanations will appear here in structured blocks.
          </div>
        </section>
      </div>
    </main>

    <!-- EARLY_ACCESS_START: Premium Activation Modal hidden during early access
    <div class="modal-overlay" id="premium-modal">
      <div class="modal">
        <h2>‚ö° Activate Premium</h2>
        <p>Enter the activation code from your purchase confirmation.</p>
        <div id="modal-message" class="modal-message" style="display: none;"></div>
        <input 
          type="text" 
          class="modal-input" 
          id="premium-code-input" 
          placeholder="ALGO-XXXXXX"
          maxlength="11"
        />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>
          <button class="modal-btn modal-btn-primary" id="modal-activate">Activate</button>
        </div>
      </div>
    </div>
    EARLY_ACCESS_END -->

    <!-- Feedback Modal -->
    <div class="feedback-modal-overlay" id="feedback-modal">
      <div class="feedback-modal">
        <h3 id="feedback-modal-title">What did you like?</h3>
        <div class="feedback-options" id="feedback-options">
          <!-- Options injected by JS based on thumbs up/down -->
        </div>
        <button class="feedback-modal-skip" id="feedback-modal-skip">Skip</button>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
      <div class="modal">
        <h2>Need Help?</h2>
        <p>Have questions, concerns, or running into issues? We're here to help!</p>
        <div style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 8px; margin: 16px 0;">
          <p style="margin: 0; color: var(--text-main);">
            Contact us at:<br>
            <a href="mailto:support@algo-tutor.org" style="color: var(--accent); font-weight: 600; font-size: 1.1rem;">
              support@algo-tutor.org
            </a>
          </p>
        </div>
        <p style="font-size: 0.85rem; color: var(--text-muted);">
          We typically respond within 24 hours.
        </p>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="help-modal-close">Close</button>
          <a href="mailto:support@algo-tutor.org" class="modal-btn modal-btn-primary" style="text-decoration: none; text-align: center;">
            Send Email
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      // EARLY_ACCESS: Set to false to re-enable premium activation features
      // During early access, all features are free - no premium activation needed
      const EARLY_ACCESS_MODE = true;
      
      // DEBUGGING: Log everything available on window
      console.log("============================================");
      console.log("[Widget] INITIAL LOAD - Checking window object");
      console.log("[Widget] EARLY_ACCESS_MODE:", EARLY_ACCESS_MODE);
      console.log("[Widget] window.openai:", window.openai);
      console.log("[Widget] window.state:", window.state);
      console.log("[Widget] Full window keys:", Object.keys(window).filter(k => k.includes('openai') || k.includes('state') || k.includes('widget')));
      console.log("============================================");

      // State management
      let currentMode = "learn";
      let currentState = {
        mode: null,
        outputs: null,
      };
      let currentLogId = null; // For feedback tracking
      let currentLearnTopic = null; // For Learn Mode follow-up questions
      let currentLearnCode = ''; // For Learn Mode trace walkthrough
      
      // Build Mode follow-up state
      let currentBuildProblem = ''; // For Build Mode follow-up context
      let currentBuildCode = ''; // Code from Build Mode response
      let currentBuildTestCases = ''; // Detected test cases from problem
      let currentBuildConstraints = ''; // Detected constraints from problem
      let buildTraceHasBeenUsed = false; // Track if trace/walkthrough has been used
      let buildExplainHasBeenUsed = false; // Track if explain has been used
      let lastBuildResponse = null; // Store last response for context-aware follow-ups

      // Debug Mode follow-up state
      let currentDebugCode = ''; // The code being debugged (or from similar problem)
      let currentDebugLanguage = 'python'; // Language of the code
      let currentDebugProblem = ''; // What the code does (from whatCodeDoes)
      let currentDebugTopic = ''; // Algorithm/pattern inferred from the code
      let currentDebugBugInfo = ''; // Bug diagnosis info to focus blanks on the issue
      let lastDebugResponse = null; // Store last response for context-aware follow-ups

      // DOM Elements
      const modeBtns = document.querySelectorAll(".mode-btn");
      const modeForms = {
        learn: document.querySelector("#learn-form"),
        build: document.querySelector("#build-form"),
        debug: document.querySelector("#debug-form"),
      };
      const outputContainer = document.querySelector("#output-container");

      // Helper: Get state from ChatGPT - with extensive logging
      const getInitialState = () => {
        console.log("[Widget] getInitialState() called");
        
        // Check all possible locations
        console.log("[Widget] Checking window.openai:", window.openai);
        console.log("[Widget] Checking window.openai?.globals:", window.openai?.globals);
        console.log("[Widget] Checking window.openai?.state:", window.openai?.state);
        console.log("[Widget] Checking window.openai?.widgetState:", window.openai?.widgetState);
        console.log("[Widget] Checking window.openai?.initialState:", window.openai?.initialState);
        
        const w = window.openai || {};
        
        // Try all possible paths
        if (w.globals?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.globals.toolOutput");
          return w.globals.toolOutput;
        }
        if (w.state?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.state.toolOutput");
          return w.state.toolOutput;
        }
        if (w.widgetState?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.widgetState.toolOutput");
          return w.widgetState.toolOutput;
        }
        if (w.initialState?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.initialState.toolOutput");
          return w.initialState.toolOutput;
        }
        if (w.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.toolOutput");
          return w.toolOutput;
        }
        
        console.warn("[Widget] ‚ùå No initial state found anywhere");
        return { mode: null, outputs: null };
      };

      currentState = getInitialState();
      console.log("[Widget] Initial currentState:", JSON.stringify(currentState, null, 2));

      // Mode switching
      modeBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          currentMode = mode;

          // Update button states
          modeBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // Update form visibility
          Object.values(modeForms).forEach((form) =>
            form.classList.remove("active")
          );
          modeForms[mode].classList.add("active");
        });
      });

      // Send follow-up message to ChatGPT
      const sendFollowUp = async (prompt) => {
        if (window.openai?.sendFollowUpMessage) {
          return await window.openai.sendFollowUpMessage({ prompt });
        }
        throw new Error("OpenAI sendFollowUpMessage API not available");
      };

      // Render outputs - Exam Cheat Code Edition
      const renderOutputs = (outputs) => {
        console.log("[Widget] ==================== renderOutputs CALLED ====================");
        console.log("[Widget] Outputs received:", JSON.stringify(outputs, null, 2));
        console.log("[Widget] Outputs type:", typeof outputs);
        console.log("[Widget] Outputs keys:", outputs ? Object.keys(outputs) : "null");
        
        outputContainer.innerHTML = "";

        if (!outputs) {
          console.warn("[Widget] No outputs provided - showing empty state");
          outputContainer.innerHTML =
            '<div class="output-empty">No outputs yet. Submit a query to see results.</div>';
          return;
        }

        // Check for validation errors (invalid/irrelevant input)
        if (outputs.invalidInput) {
          console.log("[Widget] Validation error detected:", outputs.message);
          outputContainer.innerHTML = `
            <div class="validation-error">
              <div class="validation-error-icon">‚ö†Ô∏è</div>
              <div class="validation-error-text">${escapeHtml(outputs.message || 'Invalid input. Please try again with a valid DSA topic, coding problem, or code snippet.')}</div>
            </div>
          `;
          return;
        }

        // Check if outputs is an empty object
        if (typeof outputs === 'object' && Object.keys(outputs).length === 0) {
          console.warn("[Widget] Outputs is an empty object");
          outputContainer.innerHTML =
            '<div class="output-empty">‚ö†Ô∏è Received empty outputs. Please try again.</div>';
          return;
        }

        // Check if ALL fields are empty/null
        const hasContent = Object.values(outputs).some(val => {
          if (val === null || val === undefined) return false;
          if (typeof val === 'string') return val.trim().length > 0;
          if (Array.isArray(val)) return val.length > 0;
          if (typeof val === 'object') return Object.keys(val).length > 0;
          return true;
        });

        if (!hasContent) {
          console.warn("[Widget] All output fields are empty:", outputs);
          outputContainer.innerHTML =
            '<div class="output-empty">‚ö†Ô∏è ChatGPT did not generate content. Please try again.<br><small style="color: #9ca3af; margin-top: 8px; display: block;">Tip: Make sure to describe what you want clearly.</small></div>';
          return;
        }

        console.log("[Widget] ‚úÖ Outputs has content, proceeding to render blocks");
        
        // === AI RECOMMENDATION RENDERING ===
        if (outputs.isAIRecommendation) {
          const recContainer = document.createElement('div');
          recContainer.className = 'ai-recommendation-container';
          recContainer.innerHTML = `<div class="ai-recommendation-title">ü§ñ AI Study Recommendation</div>`;
          
          // Helper to render a section with a list of points
          const addRecSection = (title, items) => {
            if (!items || (Array.isArray(items) && items.length === 0)) return;
            const sectionEl = document.createElement('div');
            sectionEl.className = 'ai-recommendation-section';
            sectionEl.innerHTML = `
              <div class="ai-recommendation-section-title">${escapeHtml(title)}</div>
              <div class="ai-recommendation-section-content">${
                Array.isArray(items)
                  ? '<ul>' + items.map(p => `<li>${escapeHtml(p)}</li>`).join('') + '</ul>'
                  : escapeHtml(String(items)).replace(/\n/g, '<br>')
              }</div>
            `;
            recContainer.appendChild(sectionEl);
          };
          
          addRecSection('üìö What to Study', outputs.whatToStudy);
          addRecSection('üîç Pattern Recognition Tips', outputs.patternTips);
          addRecSection('üéØ Practice Strategy', outputs.practiceStrategy);
          addRecSection('üí° Key Takeaways', outputs.keyTakeaways);
          
          // Encouragement (displayed differently - as a callout)
          if (outputs.encouragement) {
            const encEl = document.createElement('div');
            encEl.className = 'ai-recommendation-section';
            encEl.innerHTML = `
              <div style="padding: 10px 14px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981; font-size: 0.85rem; line-height: 1.6;">
                üí™ ${escapeHtml(outputs.encouragement)}
              </div>
            `;
            recContainer.appendChild(encEl);
          }
          
          outputContainer.appendChild(recContainer);
          return;
        }
        
        // Determine mode based on outputs
        const isDebugMode = outputs.exactBugLine || outputs.fillInBlankAnswers || outputs.beforeCode || outputs.isDebugFillInBlank;
        const isBuildMode = outputs.theShortcut || outputs.dontForget || outputs.isBuildMode;
        const isLearnMode = outputs.patternSignature || outputs.whatProfessorsTest || outputs.isLearnMode;

        // === RENDER TRICK BOX FIRST (TOP OF OUTPUT) ===
        if (outputs.theTrick) {
          const trickClass = isDebugMode ? 'debug' : (isBuildMode ? 'build' : '');
          const trickTitle = isDebugMode ? 'THE TRICK' : (isBuildMode ? 'THE SHORTCUT' : 'THE TRICK');
          const trickEl = document.createElement('div');
          trickEl.className = `trick-box ${trickClass}`;
          trickEl.innerHTML = `
            <div class="trick-box-title">${trickTitle}</div>
            <div class="trick-box-content">${escapeHtml(outputs.theTrick)}</div>
          `;
          outputContainer.appendChild(trickEl);
        }
        
        // Build Mode: The Shortcut
        if (outputs.theShortcut && !outputs.theTrick) {
          const trickEl = document.createElement('div');
          trickEl.className = 'trick-box build';
          trickEl.innerHTML = `
            <div class="trick-box-title">THE SHORTCUT</div>
            <div class="trick-box-content">${escapeHtml(outputs.theShortcut)}</div>
          `;
          outputContainer.appendChild(trickEl);
        }

        // === MAIN CONTENT BLOCKS ===
        const blocks = [];

        // What Code Does (Debug/Trace mode)
        if (outputs.whatCodeDoes) {
          blocks.push({
            title: "What This Code Does",
            content: outputs.whatCodeDoes,
            type: "text",
          });
        }

        // Pattern Detection
        if (outputs.pattern) {
          blocks.push({
            title: "Pattern Detection",
            content: outputs.pattern,
            type: "text",
          });
        }

        // Pattern Signature Keywords (Learn/Pattern Recognition mode)
        if (outputs.patternSignature && Array.isArray(outputs.patternSignature)) {
          blocks.push({
            title: "Pattern Signature",
            content: outputs.patternSignature,
            type: "keywords",
          });
        }

        // Step-by-step reasoning
        if (outputs.stepByStep) {
          blocks.push({
            title: "Step-by-Step",
            content: outputs.stepByStep,
            type: "text",
          });
        }

        // Code Solution
        if (outputs.code) {
          blocks.push({
            title: "Code Solution",
            content: outputs.code,
            type: "code",
          });
        }

        // Example Walkthrough (Learn mode only - skip for Build Mode and Debug Mode trace responses)
        if (outputs.exampleWalkthrough && !outputs.isBuildTraceWalkthrough && !outputs.isDebugTraceWalkthrough) {
          blocks.push({
            title: "Example Walkthrough",
            content: outputs.exampleWalkthrough,
            type: "text",
          });
        }

        // Exact Bug Line (Debug mode)
        if (outputs.exactBugLine) {
          blocks.push({
            title: "Exact Bug Location",
            content: outputs.exactBugLine,
            type: "bugLine",
          });
        }

        // Trace Table / Dry-run table (exam format) - skip for Build Mode and Debug Mode trace responses
        if (outputs.traceTable && Array.isArray(outputs.traceTable) && !outputs.isBuildTraceWalkthrough && !outputs.isDebugTraceWalkthrough) {
          blocks.push({
            title: "Trace Table (Exam Format)",
            content: outputs.traceTable,
            type: "table",
          });
        } else if (outputs.dryRunTable && Array.isArray(outputs.dryRunTable) && !outputs.isBuildTraceWalkthrough && !outputs.isDebugTraceWalkthrough) {
          blocks.push({
            title: "Trace Table (Exam Format)",
            content: outputs.dryRunTable,
            type: "table",
          });
        }

        // Fill-in-Blank Answers (Debug mode)
        if (outputs.fillInBlankAnswers && Array.isArray(outputs.fillInBlankAnswers)) {
          blocks.push({
            title: "Fill-in-the-Blank Answers",
            content: outputs.fillInBlankAnswers,
            type: "fillInBlank",
          });
        }

        // Bug Diagnosis (Debug mode)
        if (outputs.bugDiagnosis) {
          blocks.push({
            title: "Bug Diagnosis",
            content: outputs.bugDiagnosis,
            type: "text",
          });
        }

        // Before/After code (Debug mode)
        if (outputs.beforeCode || outputs.afterCode) {
          blocks.push({
            title: "Before & After Fix",
            content: `<div><strong>Before:</strong><pre class="code-block">${escapeHtml(
              outputs.beforeCode || "N/A"
            )}</pre></div><div style="margin-top: 12px;"><strong>After:</strong><pre class="code-block">${escapeHtml(
              outputs.afterCode || "N/A"
            )}</pre></div>`,
            type: "html",
          });
        }

        // Complexity analysis
        if (outputs.complexity) {
          blocks.push({
            title: "Time & Space Complexity",
            content: outputs.complexity,
            type: "text",
          });
        }

        // Render main blocks
        blocks.forEach((block, idx) => {
          if (block.type === "keywords") {
            // Render as keyword tags
            const blockEl = document.createElement("div");
            blockEl.className = "output-block";
            blockEl.innerHTML = `<h3>${block.title}</h3>`;
            const keywordsDiv = document.createElement("div");
            keywordsDiv.className = "pattern-keywords";
            block.content.forEach(keyword => {
              const tag = document.createElement("span");
              tag.className = "keyword-tag";
              tag.textContent = keyword;
              keywordsDiv.appendChild(tag);
            });
            blockEl.appendChild(keywordsDiv);
            outputContainer.appendChild(blockEl);
            return;
          }

          if (block.type === "bugLine") {
            // Render bug line highlight - handles single bug or multiple bugs
            const blockEl = document.createElement("div");
            blockEl.className = "output-block";
            blockEl.innerHTML = `<h3>${block.title}</h3>`;
            
            // Handle both single bug (object) and multiple bugs (array)
            const bugs = Array.isArray(block.content) ? block.content : [block.content];
            
            bugs.forEach((line, index) => {
              const bugBox = document.createElement("div");
              bugBox.className = "bug-line-box";
              bugBox.style.marginBottom = index < bugs.length - 1 ? "12px" : "0";
              
              const bugNumber = bugs.length > 1 ? `Bug ${index + 1} - ` : "";
              bugBox.innerHTML = `
                <div class="bug-line-number">${bugNumber}Line ${line.lineNumber || '?'}</div>
                <div class="bug-line-code">${escapeHtml(line.code || '')}</div>
                <div class="bug-line-issue">${escapeHtml(line.issue || '')}</div>
              `;
              blockEl.appendChild(bugBox);
            });
            
            outputContainer.appendChild(blockEl);
            return;
          }

          if (block.type === "fillInBlank") {
            // Render fill-in-blank answers
            const blockEl = document.createElement("div");
            blockEl.className = "output-block";
            blockEl.innerHTML = `<h3>${block.title}</h3>`;
            block.content.forEach(item => {
              const answerDiv = document.createElement("div");
              answerDiv.className = "blank-answer";
              answerDiv.innerHTML = `
                <div class="blank-answer-label">${escapeHtml(item.blank || 'Blank')}</div>
                <div class="blank-answer-code">${escapeHtml(item.answer || '')}</div>
                <div class="blank-answer-reason">${escapeHtml(item.reason || '')}</div>
              `;
              blockEl.appendChild(answerDiv);
            });
            outputContainer.appendChild(blockEl);
            return;
          }

          // Standard block rendering
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";

          const titleEl = document.createElement("h3");
          titleEl.textContent = block.title;
          blockEl.appendChild(titleEl);

          const contentEl = document.createElement("div");
          contentEl.className = "output-content";

          if (block.type === "code") {
            contentEl.innerHTML = `<pre class="code-block">${escapeHtml(block.content)}</pre>`;
          } else if (block.type === "table" && Array.isArray(block.content)) {
            const table = renderTable(block.content);
            if (table) contentEl.appendChild(table);
          } else if (block.type === "list" && Array.isArray(block.content)) {
            const ul = document.createElement("ul");
            ul.className = "list-block";
            block.content.forEach((item) => {
              const li = document.createElement("li");
              li.textContent = typeof item === 'string' ? item : JSON.stringify(item);
              ul.appendChild(li);
            });
            contentEl.appendChild(ul);
          } else if (block.type === "html") {
            contentEl.innerHTML = block.content;
          } else {
            contentEl.innerHTML = String(block.content).replace(/\n/g, "<br>");
          }

          blockEl.appendChild(contentEl);
          outputContainer.appendChild(blockEl);
        });

        // === WARNING BOXES (near bottom) ===
        
        // Don't Forget (Build mode)
        if (outputs.dontForget) {
          const warningEl = document.createElement("div");
          warningEl.className = "warning-box";
          warningEl.innerHTML = `
            <div class="warning-box-title">DON'T FORGET</div>
            <div class="warning-box-content">${escapeHtml(outputs.dontForget)}</div>
          `;
          outputContainer.appendChild(warningEl);
        }

        // What Professors Test (Learn mode)
        if (outputs.whatProfessorsTest) {
          const warningEl = document.createElement("div");
          warningEl.className = "warning-box";
          warningEl.innerHTML = `
            <div class="warning-box-title">WHAT PROFESSORS TEST</div>
            <div class="warning-box-content">${escapeHtml(outputs.whatProfessorsTest)}</div>
          `;
          outputContainer.appendChild(warningEl);
        }

        // If On Exam (Debug mode)
        if (outputs.ifOnExam) {
          const examTipEl = document.createElement("div");
          examTipEl.className = "exam-tip-box";
          examTipEl.innerHTML = `
            <div class="exam-tip-title">IF THIS APPEARS ON EXAM</div>
            <div class="exam-tip-content">${escapeHtml(outputs.ifOnExam)}</div>
          `;
          outputContainer.appendChild(examTipEl);
        }

        // === BOTTOM SECTION ===

        // Paper Summary (Learn mode only - paperVersion removed from Build mode)
        if (outputs.paperSummary && Array.isArray(outputs.paperSummary)) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Paper Summary (Exam Day)</h3>`;
          const ul = document.createElement("ul");
          ul.className = "list-block";
          outputs.paperSummary.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          blockEl.appendChild(ul);
          outputContainer.appendChild(blockEl);
        }

        // Test Cases (skip for real-world examples, similar problems, debug trace walkthrough, and initial debug mode - test cases only shown in follow-ups)
        const isInitialDebugResponse = isDebugMode && !outputs.isDebugTraceWalkthrough && !outputs.isDebugSimilarProblem;
        if (outputs.testCases && Array.isArray(outputs.testCases) && !outputs.isRealWorldExample && !outputs.isDebugSimilarProblem && !isInitialDebugResponse && !outputs.isDebugTraceWalkthrough) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Test Cases</h3>`;
          const ul = document.createElement("ul");
          ul.className = "list-block";
          outputs.testCases.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          blockEl.appendChild(ul);
          outputContainer.appendChild(blockEl);
        }

        // Edge Cases - supports both old format (strings) and new format (objects with case and hint)
        if (outputs.edgeCases && Array.isArray(outputs.edgeCases)) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Edge Cases</h3>`;
          
          outputs.edgeCases.forEach((item) => {
            if (typeof item === 'object' && item.case) {
              // New format: {case: "...", hint: "..."}
              const edgeCaseDiv = document.createElement("div");
              edgeCaseDiv.className = "blank-answer"; // Reuse this style
              edgeCaseDiv.innerHTML = `
                <div class="blank-answer-label">${escapeHtml(item.case)}</div>
                <div class="blank-answer-reason">${escapeHtml(item.hint || '')}</div>
              `;
              blockEl.appendChild(edgeCaseDiv);
            } else {
              // Old format: just a string
              const li = document.createElement("div");
              li.style.padding = "8px 0";
              li.style.borderBottom = "1px solid var(--border-subtle)";
              li.textContent = typeof item === 'string' ? item : JSON.stringify(item);
              blockEl.appendChild(li);
            }
          });
          
          outputContainer.appendChild(blockEl);
        }

        // === TRACE TABLE & WALKTHROUGH RESPONSE (Learn Mode) ===
        if (outputs.isTraceWalkthrough) {
          // Render example input/output
          if (outputs.exampleInput || outputs.exampleOutput) {
            const ioDiv = document.createElement("div");
            ioDiv.className = "example-io";
            if (outputs.exampleInput) {
              ioDiv.innerHTML += `
                <div class="example-io-item">
                  <div class="example-io-label">Example Input</div>
                  <div class="example-io-value">${escapeHtml(outputs.exampleInput)}</div>
                </div>
              `;
            }
            if (outputs.exampleOutput) {
              ioDiv.innerHTML += `
                <div class="example-io-item">
                  <div class="example-io-label">Expected Output</div>
                  <div class="example-io-value">${escapeHtml(outputs.exampleOutput)}</div>
                </div>
              `;
            }
            outputContainer.appendChild(ioDiv);
          }
        }
        
        // === BUILD MODE TRACE TABLE & WALKTHROUGH RESPONSE ===
        if (outputs.isBuildTraceWalkthrough) {
          // Check if this is a level 3 response with both normal and edge cases
          if (outputs.normalCase && outputs.edgeCase) {
            // Level 3: Render both cases - Order: Walkthrough ‚Üí Input/Output ‚Üí Table
            const bothCasesContainer = document.createElement("div");
            bothCasesContainer.className = "trace-walkthrough-container";
            
            // Normal Case
            bothCasesContainer.innerHTML += `
              <h3 style="color: var(--accent); margin-bottom: 12px;">üìä Normal Case</h3>
            `;
            // 1. Walkthrough FIRST
            if (outputs.normalCase.exampleWalkthrough) {
              const walkthroughEl = document.createElement("div");
              walkthroughEl.className = "output-block";
              walkthroughEl.innerHTML = `<h3>Walkthrough</h3><div class="text-block">${escapeHtml(outputs.normalCase.exampleWalkthrough).replace(/\n/g, '<br>')}</div>`;
              bothCasesContainer.appendChild(walkthroughEl);
            }
            // 2. Input/Output SECOND
            if (outputs.normalCase.exampleInput || outputs.normalCase.exampleOutput) {
              const normalIoDiv = document.createElement("div");
              normalIoDiv.className = "example-io";
              normalIoDiv.style.marginTop = "12px";
              normalIoDiv.innerHTML = `
                ${outputs.normalCase.exampleInput ? `<div class="example-io-item"><div class="example-io-label">Input (used in trace below)</div><div class="example-io-value">${escapeHtml(outputs.normalCase.exampleInput)}</div></div>` : ''}
                ${outputs.normalCase.exampleOutput ? `<div class="example-io-item"><div class="example-io-label">Output</div><div class="example-io-value">${escapeHtml(outputs.normalCase.exampleOutput)}</div></div>` : ''}
              `;
              bothCasesContainer.appendChild(normalIoDiv);
            }
            // 3. Table THIRD
            if (outputs.normalCase.dryRunTable && Array.isArray(outputs.normalCase.dryRunTable)) {
              const tableEl = renderTable(outputs.normalCase.dryRunTable);
              if (tableEl) bothCasesContainer.appendChild(tableEl);
            }
            
            // Edge Case
            bothCasesContainer.innerHTML += `
              <h3 style="color: #f59e0b; margin-top: 24px; margin-bottom: 12px;">‚ö†Ô∏è Edge Case</h3>
            `;
            // 1. Walkthrough FIRST
            if (outputs.edgeCase.exampleWalkthrough) {
              const walkthroughEl = document.createElement("div");
              walkthroughEl.className = "output-block";
              walkthroughEl.innerHTML = `<h3>Walkthrough</h3><div class="text-block">${escapeHtml(outputs.edgeCase.exampleWalkthrough).replace(/\n/g, '<br>')}</div>`;
              bothCasesContainer.appendChild(walkthroughEl);
            }
            // 2. Input/Output SECOND
            if (outputs.edgeCase.exampleInput || outputs.edgeCase.exampleOutput) {
              const edgeIoDiv = document.createElement("div");
              edgeIoDiv.className = "example-io";
              edgeIoDiv.style.marginTop = "12px";
              edgeIoDiv.innerHTML = `
                ${outputs.edgeCase.exampleInput ? `<div class="example-io-item"><div class="example-io-label">Input (used in trace below)</div><div class="example-io-value">${escapeHtml(outputs.edgeCase.exampleInput)}</div></div>` : ''}
                ${outputs.edgeCase.exampleOutput ? `<div class="example-io-item"><div class="example-io-label">Output</div><div class="example-io-value">${escapeHtml(outputs.edgeCase.exampleOutput)}</div></div>` : ''}
              `;
              bothCasesContainer.appendChild(edgeIoDiv);
            }
            // 3. Table THIRD
            if (outputs.edgeCase.dryRunTable && Array.isArray(outputs.edgeCase.dryRunTable)) {
              const tableEl = renderTable(outputs.edgeCase.dryRunTable);
              if (tableEl) bothCasesContainer.appendChild(tableEl);
            }
            // 4. Why Important
            if (outputs.edgeCase.whyImportant) {
              const whyEl = document.createElement("div");
              whyEl.className = "warning-box";
              whyEl.innerHTML = `<div class="warning-title">Why This Edge Case Matters</div><div>${escapeHtml(outputs.edgeCase.whyImportant)}</div>`;
              bothCasesContainer.appendChild(whyEl);
            }
            
            outputContainer.appendChild(bothCasesContainer);
          } else {
            // Level 1 or 2: Single case - Order: Walkthrough ‚Üí Input/Output ‚Üí Table
            const singleCaseContainer = document.createElement("div");
            singleCaseContainer.className = "trace-walkthrough-container";
            
            // 1. Walkthrough FIRST
            if (outputs.exampleWalkthrough) {
              const walkthroughEl = document.createElement("div");
              walkthroughEl.className = "output-block";
              walkthroughEl.innerHTML = `<h3>Example Walkthrough</h3><div class="text-block">${escapeHtml(outputs.exampleWalkthrough).replace(/\n/g, '<br>')}</div>`;
              singleCaseContainer.appendChild(walkthroughEl);
            }
            
            // 2. Input/Output SECOND
            if (outputs.exampleInput || outputs.exampleOutput) {
              const ioDiv = document.createElement("div");
              ioDiv.className = "example-io";
              ioDiv.style.marginTop = "16px";
              if (outputs.exampleInput) {
                ioDiv.innerHTML += `
                  <div class="example-io-item">
                    <div class="example-io-label">Example Input (used in trace below)</div>
                    <div class="example-io-value">${escapeHtml(outputs.exampleInput)}</div>
                  </div>
                `;
              }
              if (outputs.exampleOutput) {
                ioDiv.innerHTML += `
                  <div class="example-io-item">
                    <div class="example-io-label">Expected Output</div>
                    <div class="example-io-value">${escapeHtml(outputs.exampleOutput)}</div>
                  </div>
                `;
              }
              singleCaseContainer.appendChild(ioDiv);
            }
            
            // 3. Trace Table THIRD
            if (outputs.dryRunTable && Array.isArray(outputs.dryRunTable)) {
              const tableTitle = document.createElement("h3");
              tableTitle.textContent = "Trace Table";
              tableTitle.style.marginTop = "16px";
              tableTitle.style.marginBottom = "8px";
              singleCaseContainer.appendChild(tableTitle);
              
              const tableEl = renderTable(outputs.dryRunTable);
              if (tableEl) singleCaseContainer.appendChild(tableEl);
            }
            
            outputContainer.appendChild(singleCaseContainer);
          }
        }
        
        // === BUILD MODE EXPLAIN SIMPLE RESPONSE ===
        if (outputs.isBuildExplainSimple) {
          const explainContainer = document.createElement("div");
          explainContainer.className = "trace-walkthrough-container";
          
          // Real World Analogy (Level 3)
          if (outputs.realWorldAnalogy) {
            const analogyEl = document.createElement("div");
            analogyEl.className = "trick-box";
            analogyEl.innerHTML = `
              <div class="trick-box-title">üåç Real-World Analogy</div>
              <div class="trick-box-content">${escapeHtml(outputs.realWorldAnalogy)}</div>
            `;
            explainContainer.appendChild(analogyEl);
          }
          
          // Detailed Explanation
          if (outputs.detailedExplanation) {
            const detailEl = document.createElement("div");
            detailEl.className = "output-block";
            detailEl.innerHTML = `
              <h3>Step-by-Step Explanation</h3>
              <div class="text-block">${escapeHtml(outputs.detailedExplanation).replace(/\n/g, '<br>')}</div>
            `;
            explainContainer.appendChild(detailEl);
          }
          
          // Pattern Explanation
          if (outputs.patternExplanation) {
            const patternEl = document.createElement("div");
            patternEl.className = "output-block";
            patternEl.innerHTML = `
              <h3>How to Approach This Pattern</h3>
              <div class="text-block">${escapeHtml(outputs.patternExplanation).replace(/\n/g, '<br>')}</div>
            `;
            explainContainer.appendChild(patternEl);
          }
          
          // Skeleton Code
          if (outputs.skeleton) {
            const skeletonEl = document.createElement("div");
            skeletonEl.className = "output-block";
            skeletonEl.innerHTML = `
              <h3>Code Skeleton</h3>
              <pre class="code-block">${escapeHtml(outputs.skeleton)}</pre>
            `;
            explainContainer.appendChild(skeletonEl);
          }
          
          // Key Insights
          if (outputs.keyInsights && Array.isArray(outputs.keyInsights)) {
            const insightsEl = document.createElement("div");
            insightsEl.className = "output-block";
            insightsEl.innerHTML = `<h3>üí° Key Insights</h3>`;
            const ul = document.createElement("ul");
            ul.className = "list-block";
            outputs.keyInsights.forEach(insight => {
              const li = document.createElement("li");
              li.textContent = insight;
              ul.appendChild(li);
            });
            insightsEl.appendChild(ul);
            explainContainer.appendChild(insightsEl);
          }
          
          // Common Mistakes
          if (outputs.commonMistakes && Array.isArray(outputs.commonMistakes)) {
            const mistakesEl = document.createElement("div");
            mistakesEl.className = "warning-box";
            mistakesEl.innerHTML = `<div class="warning-title">‚ö†Ô∏è Common Mistakes to Avoid</div>`;
            const ul = document.createElement("ul");
            ul.style.marginTop = "8px";
            ul.style.paddingLeft = "20px";
            ul.style.color = "#1f2937";
            outputs.commonMistakes.forEach(mistake => {
              const li = document.createElement("li");
              li.textContent = mistake;
              li.style.marginBottom = "4px";
              li.style.color = "#1f2937";
              ul.appendChild(li);
            });
            mistakesEl.appendChild(ul);
            explainContainer.appendChild(mistakesEl);
          }
          
          outputContainer.appendChild(explainContainer);
        }

        // === REAL WORLD EXAMPLE (FILL-IN-THE-BLANK) RESPONSE ===
        if (outputs.isRealWorldExample) {
          renderFillInBlankProblem(outputs);
        }

        // === LEARN MODE FOLLOW-UP BUTTONS ===
        // Show follow-up buttons after Learn Mode, Trace/Walkthrough, and Real-World Example responses
        const showLearnFollowupButtons = outputs.isLearnMode || outputs.isTraceWalkthrough || outputs.isRealWorldExample;
        const topicForFollowup = outputs.topicIdentified || currentLearnTopic;
        
        if (showLearnFollowupButtons && topicForFollowup) {
          // Update stored topic if we have a new one
          if (outputs.topicIdentified) {
            currentLearnTopic = outputs.topicIdentified;
          }
          if (outputs.code) {
            currentLearnCode = outputs.code;
          }
          
          const followupContainer = document.createElement("div");
          followupContainer.className = "followup-buttons-container";
          followupContainer.innerHTML = `
            <div class="followup-buttons-title">Want to continue learning?</div>
            <button class="followup-btn" data-action="trace-walkthrough" data-topic="${escapeHtml(topicForFollowup)}" data-code="${escapeHtml(currentLearnCode || '')}">
              <span class="followup-btn-icon">üìä</span>
              <span class="followup-btn-text">See a trace table and example walkthrough</span>
              <span class="followup-btn-arrow">‚Üí</span>
            </button>
            <button class="followup-btn" data-action="real-world" data-topic="${escapeHtml(topicForFollowup)}">
              <span class="followup-btn-icon">üß©</span>
              <span class="followup-btn-text">Try a real-world practice problem</span>
              <span class="followup-btn-arrow">‚Üí</span>
            </button>
          `;
          outputContainer.appendChild(followupContainer);
        }
        
        // === BUILD MODE FOLLOW-UP BUTTONS ===
        // Show progressive follow-up buttons after Build Mode responses
        const showBuildFollowupButtons = isBuildMode && outputs.code && !outputs.isBuildTraceWalkthrough && !outputs.isBuildExplainSimple;
        
        if (showBuildFollowupButtons) {
          // Store Build Mode context for follow-ups
          if (outputs.code) {
            currentBuildCode = outputs.code;
          }
          // Problem is stored via form submission, but also from detected context
          if (outputs.testCasesDetected) {
            currentBuildTestCases = outputs.testCasesDetected;
          }
          if (outputs.constraintsDetected) {
            currentBuildConstraints = outputs.constraintsDetected;
          }
          // Reset flags for new Build Mode response
          buildTraceHasBeenUsed = false;
          buildExplainHasBeenUsed = false;
          lastBuildResponse = outputs;
          
          // First-time button text
          const traceText = "See example walkthrough and trace table";
          const explainText = "Explain in simpler terms";
          
          const buildFollowupContainer = document.createElement("div");
          buildFollowupContainer.className = "followup-buttons-container";
          buildFollowupContainer.id = "build-followup-container";
          buildFollowupContainer.innerHTML = `
            <div class="followup-buttons-title">Want to understand better?</div>
            <button class="followup-btn build-followup-btn" data-action="build-trace-walkthrough">
              <span class="followup-btn-icon">üìä</span>
              <span class="followup-btn-text">${traceText}</span>
              <span class="followup-btn-arrow">‚Üí</span>
            </button>
            <button class="followup-btn build-followup-btn" data-action="build-explain-simple">
              <span class="followup-btn-icon">üí°</span>
              <span class="followup-btn-text">${explainText}</span>
              <span class="followup-btn-arrow">‚Üí</span>
            </button>
          `;
          outputContainer.appendChild(buildFollowupContainer);
        }
        
        // === BUILD MODE FOLLOW-UP RESPONSE (TRACE OR EXPLAIN) ===
        // No further follow-up buttons after a follow-up response ‚Äî one-shot only
        if (outputs.isBuildTraceWalkthrough || outputs.isBuildExplainSimple) {
          lastBuildResponse = outputs;
        }
        
        // === DEBUG MODE: CORRECT CODE - ALTERNATIVE APPROACH ===
        if (outputs.codeIsCorrect && outputs.alternativeApproach) {
          const altContainer = document.createElement("div");
          altContainer.className = "output-block alternative-approach-block";
          altContainer.innerHTML = `
            <h3>‚úÖ Your Code is Correct!</h3>
            <p style="margin-bottom: 12px; color: var(--text-muted);">Here's an alternative approach you should know:</p>
          `;
          
          if (outputs.alternativeApproach.explanation) {
            const explainEl = document.createElement("div");
            explainEl.className = "text-block";
            explainEl.innerHTML = escapeHtml(outputs.alternativeApproach.explanation).replace(/\n/g, '<br>');
            explainEl.style.marginBottom = "12px";
            altContainer.appendChild(explainEl);
          }
          
          if (outputs.alternativeApproach.complexityComparison) {
            const compEl = document.createElement("div");
            compEl.className = "complexity-comparison";
            compEl.style.cssText = "background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--accent);";
            compEl.innerHTML = `<strong>Complexity Comparison:</strong><br>${escapeHtml(outputs.alternativeApproach.complexityComparison).replace(/\n/g, '<br>')}`;
            altContainer.appendChild(compEl);
          }
          
          if (outputs.alternativeApproach.edgeCaseImprovements) {
            const edgeEl = document.createElement("div");
            edgeEl.className = "edge-improvements";
            edgeEl.style.cssText = "background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;";
            edgeEl.innerHTML = `<strong>Edge Case Improvements:</strong><br>${escapeHtml(outputs.alternativeApproach.edgeCaseImprovements).replace(/\n/g, '<br>')}`;
            altContainer.appendChild(edgeEl);
          }
          
          outputContainer.appendChild(altContainer);
        }
        
        // === DEBUG MODE TRACE TABLE & WALKTHROUGH RESPONSE ===
        if (outputs.isDebugTraceWalkthrough) {
          const traceContainer = document.createElement("div");
          traceContainer.className = "trace-walkthrough-container";
          
          // 1. Walkthrough FIRST
          if (outputs.exampleWalkthrough) {
            const walkthroughEl = document.createElement("div");
            walkthroughEl.className = "output-block";
            walkthroughEl.innerHTML = `<h3>Example Walkthrough</h3><div class="text-block">${escapeHtml(outputs.exampleWalkthrough).replace(/\\n/g, '<br>').replace(/\n/g, '<br>')}</div>`;
            traceContainer.appendChild(walkthroughEl);
          }
          
          // 2. Input/Output SECOND
          if (outputs.exampleInput || outputs.exampleOutput) {
            const ioDiv = document.createElement("div");
            ioDiv.className = "example-io";
            ioDiv.style.marginTop = "16px";
            if (outputs.exampleInput) {
              ioDiv.innerHTML += `
                <div class="example-io-item">
                  <div class="example-io-label">Example Input (used in trace below)</div>
                  <div class="example-io-value">${escapeHtml(outputs.exampleInput)}</div>
                </div>
              `;
            }
            if (outputs.exampleOutput) {
              ioDiv.innerHTML += `
                <div class="example-io-item">
                  <div class="example-io-label">Expected Output</div>
                  <div class="example-io-value">${escapeHtml(outputs.exampleOutput)}</div>
                </div>
              `;
            }
            traceContainer.appendChild(ioDiv);
          }
          
          // 3. Trace Table THIRD
          if (outputs.dryRunTable && Array.isArray(outputs.dryRunTable)) {
            const tableTitle = document.createElement("h3");
            tableTitle.textContent = "Trace Table";
            tableTitle.style.marginTop = "16px";
            tableTitle.style.marginBottom = "8px";
            traceContainer.appendChild(tableTitle);
            
            const tableEl = renderTable(outputs.dryRunTable);
            if (tableEl) traceContainer.appendChild(tableEl);
          }
          
          // 4. Test Cases (shown in trace follow-up)
          if (outputs.testCases && Array.isArray(outputs.testCases)) {
            const testCasesEl = document.createElement("div");
            testCasesEl.className = "output-block";
            testCasesEl.style.marginTop = "16px";
            testCasesEl.innerHTML = `<h3>Test Cases</h3>`;
            const ul = document.createElement("ul");
            ul.className = "list-block";
            outputs.testCases.forEach((item) => {
              const li = document.createElement("li");
              li.textContent = item;
              ul.appendChild(li);
            });
            testCasesEl.appendChild(ul);
            traceContainer.appendChild(testCasesEl);
          }
          
          outputContainer.appendChild(traceContainer);
          
          // Update debug context from trace response
          lastDebugResponse = outputs;
        }
        
        // === DEBUG MODE FILL-IN-THE-BLANK RESPONSE ===
        if (outputs.isDebugFillInBlank) {
          const fillBlankContainer = document.createElement("div");
          fillBlankContainer.className = "debug-fillin-container";
          
          // What Code Does
          if (outputs.whatCodeDoes) {
            const whatEl = document.createElement("div");
            whatEl.className = "output-block";
            whatEl.innerHTML = `<h3>What This Code Does</h3><div class="text-block">${escapeHtml(outputs.whatCodeDoes)}</div>`;
            fillBlankContainer.appendChild(whatEl);
          }
          
          // Blank Analysis
          if (outputs.blankAnalysis && Array.isArray(outputs.blankAnalysis) && outputs.blankAnalysis.length > 0) {
            const blanksEl = document.createElement("div");
            blanksEl.className = "output-block";
            blanksEl.innerHTML = `<h3>Blank Analysis</h3>`;
            
            outputs.blankAnalysis.forEach((blank) => {
              const blankDiv = document.createElement("div");
              blankDiv.style.cssText = "padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid;";
              
              let icon, statusText, borderColor;
              if (blank.blankType === 'empty' || blank.isCorrect === null) {
                icon = 'üìù';
                statusText = 'Left blank ‚Äî filled in for you';
                borderColor = '#3b82f6';
              } else if (blank.isCorrect) {
                icon = '‚úÖ';
                statusText = 'Correct!';
                borderColor = '#10b981';
              } else {
                icon = '‚ùå';
                statusText = 'Incorrect ‚Äî corrected';
                borderColor = '#ef4444';
              }
              
              blankDiv.style.borderLeftColor = borderColor;
              blankDiv.style.background = `${borderColor}15`;
              
              blankDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-strong);">
                  ${icon} Line ${blank.lineNumber || '?'}: ${statusText}
                </div>
                ${blank.originalText ? `<div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">Original: <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px;">${escapeHtml(blank.originalText)}</code></div>` : ''}
                <div style="color: var(--text-main); font-size: 0.85rem; margin-bottom: 4px;">Correct: <code style="background: rgba(16, 185, 129, 0.15); padding: 2px 6px; border-radius: 3px; color: #10b981;">${escapeHtml(blank.correctAnswer || '')}</code></div>
                ${blank.explanation ? `<div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">${escapeHtml(blank.explanation)}</div>` : ''}
              `;
              blanksEl.appendChild(blankDiv);
            });
            
            fillBlankContainer.appendChild(blanksEl);
          }
          
          // Additional Bugs in non-blank code
          if (outputs.additionalBugs && Array.isArray(outputs.additionalBugs) && outputs.additionalBugs.length > 0) {
            const bugsEl = document.createElement("div");
            bugsEl.className = "output-block";
            bugsEl.innerHTML = `<h3>‚ö†Ô∏è Other Issues Found</h3>`;
            
            outputs.additionalBugs.forEach((bug) => {
              const bugBox = document.createElement("div");
              bugBox.className = "bug-line-box";
              bugBox.style.marginBottom = "10px";
              bugBox.innerHTML = `
                <div class="bug-line-number">Line ${bug.lineNumber || '?'}</div>
                <div class="bug-line-code">${escapeHtml(bug.code || '')}</div>
                <div class="bug-line-issue">${escapeHtml(bug.issue || '')}</div>
                ${bug.fix ? `<div style="margin-top: 6px; color: #10b981; font-size: 0.85rem;">Fix: <code style="background: rgba(16, 185, 129, 0.15); padding: 2px 6px; border-radius: 3px;">${escapeHtml(bug.fix)}</code></div>` : ''}
              `;
              bugsEl.appendChild(bugBox);
            });
            
            fillBlankContainer.appendChild(bugsEl);
          }
          
          // Fully Corrected Code
          if (outputs.fullyCorrectedCode) {
            const codeEl = document.createElement("div");
            codeEl.className = "output-block";
            codeEl.innerHTML = `
              <h3>‚úÖ Fully Corrected Code</h3>
              <div class="code-block-wrapper" style="position: relative;">
                <pre class="code-block">${escapeHtml(outputs.fullyCorrectedCode)}</pre>
              </div>
            `;
            fillBlankContainer.appendChild(codeEl);
          }
          
          outputContainer.appendChild(fillBlankContainer);
          
          // Update debug context for follow-ups
          if (outputs.fullyCorrectedCode) {
            currentDebugCode = outputs.fullyCorrectedCode;
          }
          lastDebugResponse = outputs;
        }
        
        // === DEBUG MODE SIMILAR PROBLEM RESPONSE ===
        if (outputs.isDebugSimilarProblem) {
          // Render using the same fill-in-blank function
          renderFillInBlankProblem(outputs);
          
          // Update debug context for chained follow-ups
          if (outputs.fullSolution) {
            currentDebugCode = outputs.fullSolution;
          }
          if (outputs.problemDescription) {
            currentDebugProblem = outputs.problemDescription;
          }
          lastDebugResponse = outputs;
        }
        
        // === DEBUG MODE FOLLOW-UP BUTTONS ===
        // Show follow-up buttons after Debug Mode responses (initial, trace, similar problem, or fill-in-blank)
        const showDebugFollowupButtons = isDebugMode || outputs.isDebugTraceWalkthrough || outputs.isDebugSimilarProblem || outputs.isDebugFillInBlank;
        
        if (showDebugFollowupButtons) {
          // Read echoed _debugContext from response first (survives new widget instances),
          // then fall back to response fields, then global state (empty in new widgets)
          const ctx = outputs._debugContext || {};
          
          // Update debug context from the response
          if (outputs.isDebugFillInBlank && outputs.fullyCorrectedCode) {
            // Fill-in-blank debug response - use the corrected code
            currentDebugCode = outputs.fullyCorrectedCode;
          } else if (outputs.afterCode && !outputs.isDebugTraceWalkthrough && !outputs.isDebugSimilarProblem) {
            // Initial debug response - use the fixed/alternative code
            currentDebugCode = outputs.afterCode;
          } else if (outputs.isDebugSimilarProblem && outputs.fullSolution) {
            // For similar problem responses, use the fullSolution as the code context
            currentDebugCode = outputs.fullSolution;
          } else if (ctx.code) {
            // From echoed context (new widget instance)
            currentDebugCode = ctx.code;
          }
          
          if (outputs.whatCodeDoes) {
            currentDebugProblem = outputs.whatCodeDoes;
          } else if (outputs.isDebugSimilarProblem && outputs.problemDescription) {
            currentDebugProblem = outputs.problemDescription;
          } else if (ctx.problem) {
            currentDebugProblem = ctx.problem;
          }
          
          if (outputs.relatedPatterns && outputs.relatedPatterns.length > 0) {
            currentDebugTopic = outputs.relatedPatterns[0]; // Use first related pattern as topic
          } else if (ctx.topic) {
            currentDebugTopic = ctx.topic;
          }
          
          // Extract bug info from initial debug response for focused blanks
          if (outputs.bugDiagnosis && !outputs.isDebugTraceWalkthrough && !outputs.isDebugSimilarProblem) {
            let bugInfo = outputs.bugDiagnosis;
            if (outputs.exactBugLine) {
              const bugLines = Array.isArray(outputs.exactBugLine) ? outputs.exactBugLine : [outputs.exactBugLine];
              const issuesSummary = bugLines.map(b => b.issue).filter(Boolean).join('; ');
              if (issuesSummary) {
                bugInfo += ' Issues: ' + issuesSummary;
              }
            }
            currentDebugBugInfo = bugInfo;
          } else if (ctx.bugInfo) {
            currentDebugBugInfo = ctx.bugInfo;
          }
          
          // Update language from context if available
          if (ctx.language) {
            currentDebugLanguage = ctx.language;
          }
          
          lastDebugResponse = outputs;
          
          // Embed context in data-attributes for self-contained follow-up buttons (like Learn mode)
          // This ensures follow-ups work even in new widget instances
          const debugCodeForBtn = escapeHtml(currentDebugCode || '');
          const debugLangForBtn = escapeHtml(currentDebugLanguage || 'python');
          const debugProblemForBtn = escapeHtml(currentDebugProblem || '');
          const debugTopicForBtn = escapeHtml(currentDebugTopic || '');
          const debugBugInfoForBtn = escapeHtml(currentDebugBugInfo || '');
          
          const debugFollowupContainer = document.createElement("div");
          debugFollowupContainer.className = "followup-buttons-container";
          debugFollowupContainer.id = "debug-followup-container";
          debugFollowupContainer.innerHTML = `
            <div class="followup-buttons-title">Want to practice more?</div>
            <button class="followup-btn debug-followup-btn" data-action="debug-trace-walkthrough" data-code="${debugCodeForBtn}" data-language="${debugLangForBtn}" data-problem="${debugProblemForBtn}" data-topic="${debugTopicForBtn}">
              <span class="followup-btn-icon">üìä</span>
              <span class="followup-btn-text">See example walkthrough and trace table</span>
              <span class="followup-btn-arrow">‚Üí</span>
            </button>
            <button class="followup-btn debug-followup-btn" data-action="debug-similar-problem" data-code="${debugCodeForBtn}" data-language="${debugLangForBtn}" data-problem="${debugProblemForBtn}" data-topic="${debugTopicForBtn}" data-bug-info="${debugBugInfoForBtn}">
              <span class="followup-btn-icon">üß©</span>
              <span class="followup-btn-text">Try a similar practice problem</span>
              <span class="followup-btn-arrow">‚Üí</span>
            </button>
          `;
          outputContainer.appendChild(debugFollowupContainer);
        }
        
        // Add feedback buttons for premium users
        const isPremium = !!localStorage.getItem('algotutor_premium_code');
        if (isPremium && currentLogId) {
          const feedbackEl = document.createElement("div");
          feedbackEl.className = "feedback-container";
          feedbackEl.id = "feedback-container";
          feedbackEl.innerHTML = `
            <div class="feedback-prompt">Was this helpful?</div>
            <button class="feedback-btn" data-decision="yes" title="Helpful">üëç</button>
            <button class="feedback-btn" data-decision="no" title="Not helpful">üëé</button>
          `;
          outputContainer.appendChild(feedbackEl);
          console.log("[Widget] Feedback buttons added for premium user, logId:", currentLogId);
        }
        
        // Add copy-to-clipboard buttons to all code blocks (except fill-in-blank quiz code)
        addCopyButtons(outputContainer);
        
        console.log("[Widget] ‚úÖ‚úÖ‚úÖ RENDERING COMPLETE - All blocks added to DOM");
        console.log("[Widget] outputContainer has", outputContainer.children.length, "children");
      };

      const renderTable = (rows) => {
        if (!rows || rows.length === 0) return null;

        const wrapper = document.createElement("div");
        wrapper.className = "table-wrapper";

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        // Header
        const headerRow = document.createElement("tr");
        Object.keys(rows[0]).forEach((key) => {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Rows
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          Object.values(row).forEach((val) => {
            const td = document.createElement("td");
            // Handle objects by stringifying them
            if (val === null || val === undefined) {
              td.textContent = '';
            } else if (typeof val === 'object') {
              td.textContent = JSON.stringify(val);
            } else {
              td.textContent = val;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        wrapper.appendChild(table);
        return wrapper;
      };

      const escapeHtml = (str) =>
        String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      // Render Fill-in-the-Blank Problem (for Real World Example)
      // Add copy-to-clipboard buttons to all code blocks (except fill-in-blank quiz code)
      const addCopyButtons = (container) => {
        const codeBlocks = container.querySelectorAll('pre.code-block');
        codeBlocks.forEach(pre => {
          // Skip if already has copy button or is inside a fill-in-blank quiz
          if (pre.closest('.fillin-container') || pre.closest('.fillin-code-container')) return;
          if (pre.parentElement.querySelector('.copy-code-btn')) return;
          
          // Wrap the pre in a relative container (reuse existing wrapper if present)
          let wrapper = pre.parentElement;
          if (!wrapper.classList.contains('code-block-copy-wrapper') && !wrapper.classList.contains('code-block-wrapper')) {
            wrapper = document.createElement('div');
            wrapper.className = 'code-block-copy-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
          }
          wrapper.style.position = 'relative';
          
          // Create copy button
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-code-btn';
          copyBtn.innerHTML = 'üìã Copy';
          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(pre.textContent);
              copyBtn.innerHTML = '‚úì Copied to clipboard';
              copyBtn.classList.add('copied');
              setTimeout(() => {
                copyBtn.innerHTML = 'üìã Copy';
                copyBtn.classList.remove('copied');
              }, 2000);
            } catch (err) {
              // Fallback for environments without clipboard API
              const textArea = document.createElement('textarea');
              textArea.value = pre.textContent;
              textArea.style.position = 'fixed';
              textArea.style.opacity = '0';
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              copyBtn.innerHTML = '‚úì Copied to clipboard';
              copyBtn.classList.add('copied');
              setTimeout(() => {
                copyBtn.innerHTML = 'üìã Copy';
                copyBtn.classList.remove('copied');
              }, 2000);
            }
          };
          wrapper.appendChild(copyBtn);
        });
      };

      const renderFillInBlankProblem = (outputs) => {
        const container = document.createElement("div");
        container.className = "fillin-container";
        
        // Problem Title
        if (outputs.problemTitle) {
          const titleEl = document.createElement("h2");
          titleEl.className = "fillin-problem-title";
          titleEl.textContent = outputs.problemTitle;
          container.appendChild(titleEl);
        }
        
        // Problem Description
        if (outputs.problemDescription) {
          const descEl = document.createElement("div");
          descEl.className = "fillin-problem-description";
          descEl.innerHTML = escapeHtml(outputs.problemDescription).replace(/\n/g, '<br>');
          container.appendChild(descEl);
        }
        
        // Code with Blanks
        if (outputs.codeWithBlanks) {
          const codeSection = document.createElement("div");
          codeSection.className = "fillin-code-container";
          const codeEl = document.createElement("pre");
          codeEl.className = "fillin-code";
          // Highlight blanks - support ___BLANK_N___ markers
          let highlightedCode = escapeHtml(outputs.codeWithBlanks);
          highlightedCode = highlightedCode.replace(/___BLANK_(\d+)___/g, 
            '<span style="background: rgba(245, 158, 11, 0.3); padding: 2px 8px; border-radius: 4px; color: #fbbf24;">[ BLANK $1 ]</span>');
          // Fallback: also highlight other blank patterns that LLM may produce
          highlightedCode = highlightedCode.replace(/\[BLANK\s*(\d+)\]/gi,
            '<span style="background: rgba(245, 158, 11, 0.3); padding: 2px 8px; border-radius: 4px; color: #fbbf24;">[ BLANK $1 ]</span>');
          highlightedCode = highlightedCode.replace(/_{3,}/g,
            '<span style="background: rgba(245, 158, 11, 0.3); padding: 2px 8px; border-radius: 4px; color: #fbbf24;">______</span>');
          highlightedCode = highlightedCode.replace(/#\s*YOUR\s*CODE\s*HERE/gi,
            '<span style="background: rgba(245, 158, 11, 0.3); padding: 2px 8px; border-radius: 4px; color: #fbbf24;"># YOUR CODE HERE</span>');
          highlightedCode = highlightedCode.replace(/TODO/g,
            '<span style="background: rgba(245, 158, 11, 0.3); padding: 2px 8px; border-radius: 4px; color: #fbbf24;">TODO</span>');
          codeEl.innerHTML = highlightedCode;
          codeSection.appendChild(codeEl);
          container.appendChild(codeSection);
        }
        
        // Fill-in-the-Blanks Section
        if (outputs.blanks && Array.isArray(outputs.blanks)) {
          const blanksSection = document.createElement("div");
          blanksSection.className = "fillin-blanks-section";
          blanksSection.innerHTML = `<div class="fillin-blanks-title">Fill in the Blanks</div>`;
          
          outputs.blanks.forEach((blank, idx) => {
            const blankItem = document.createElement("div");
            blankItem.className = "fillin-blank-item";
            blankItem.dataset.blankId = blank.id || idx + 1;
            blankItem.dataset.answer = blank.correctAnswer || '';
            blankItem.dataset.explanation = blank.explanation || '';
            blankItem.dataset.hint = blank.hint || '';
            blankItem.dataset.reviewTip = blank.reviewTip || '';
            blankItem.dataset.attempts = '0';
            
            // Label
            const labelEl = document.createElement("div");
            labelEl.className = "fillin-blank-label";
            labelEl.innerHTML = `<span>Blank ${blank.id || idx + 1}</span>`;
            blankItem.appendChild(labelEl);
            
            // Line Context
            if (blank.lineContext) {
              const contextEl = document.createElement("div");
              contextEl.className = "fillin-blank-context";
              contextEl.textContent = blank.lineContext;
              blankItem.appendChild(contextEl);
            }
            
            // Input Row
            const inputRow = document.createElement("div");
            inputRow.className = "fillin-input-row";
            
            if (blank.type === 'multiple_choice' && blank.options) {
              // Dropdown for multiple choice
              const select = document.createElement("select");
              select.className = "fillin-select";
              select.dataset.blankId = blank.id || idx + 1;
              select.innerHTML = `<option value="">-- Select answer --</option>`;
              blank.options.forEach(opt => {
                select.innerHTML += `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`;
              });
              inputRow.appendChild(select);
            } else {
              // Text input
              const input = document.createElement("input");
              input.type = "text";
              input.className = "fillin-text-input";
              input.dataset.blankId = blank.id || idx + 1;
              input.placeholder = "Type your answer...";
              inputRow.appendChild(input);
              
              // Hint button (for text inputs)
              if (blank.hint) {
                const hintBtn = document.createElement("button");
                hintBtn.className = "fillin-hint-btn";
                hintBtn.textContent = "üí° Hint";
                hintBtn.onclick = () => {
                  const hintEl = blankItem.querySelector('.fillin-hint');
                  if (hintEl) hintEl.classList.toggle('visible');
                };
                inputRow.appendChild(hintBtn);
              }
            }
            
            // Check button
            const checkBtn = document.createElement("button");
            checkBtn.className = "fillin-check-btn";
            checkBtn.textContent = "Check";
            checkBtn.onclick = () => checkBlankAnswer(blankItem);
            inputRow.appendChild(checkBtn);
            
            blankItem.appendChild(inputRow);
            
            // Hint text (hidden by default)
            if (blank.hint) {
              const hintEl = document.createElement("div");
              hintEl.className = "fillin-hint";
              hintEl.textContent = blank.hint;
              blankItem.appendChild(hintEl);
            }
            
            // Feedback area
            const feedbackEl = document.createElement("div");
            feedbackEl.className = "fillin-feedback";
            blankItem.appendChild(feedbackEl);
            
            blanksSection.appendChild(blankItem);
          });
          
          container.appendChild(blanksSection);
        }
        
        // Why This Tests section
        if (outputs.whyThisTests) {
          const whySection = document.createElement("div");
          whySection.className = "fillin-why-tests";
          whySection.innerHTML = `
            <div class="fillin-why-tests-title">What This Tests</div>
            <div class="fillin-why-tests-text">${escapeHtml(outputs.whyThisTests)}</div>
          `;
          container.appendChild(whySection);
        }
        
        outputContainer.appendChild(container);
      };
      
      // Check blank answer (with 3-try limit)
      const checkBlankAnswer = (blankItem) => {
        const answer = blankItem.dataset.answer;
        const explanation = blankItem.dataset.explanation;
        const hint = blankItem.dataset.hint;
        const reviewTip = blankItem.dataset.reviewTip;
        const feedbackEl = blankItem.querySelector('.fillin-feedback');
        
        // Increment attempt counter
        let attempts = parseInt(blankItem.dataset.attempts || '0') + 1;
        blankItem.dataset.attempts = attempts.toString();
        
        // Get user's answer
        const selectEl = blankItem.querySelector('.fillin-select');
        const inputEl = blankItem.querySelector('.fillin-text-input');
        const userAnswer = selectEl ? selectEl.value : (inputEl ? inputEl.value.trim() : '');
        
        // Compare answers (case-insensitive, trim whitespace)
        const isCorrect = userAnswer.toLowerCase().trim() === answer.toLowerCase().trim();
        
        // Show feedback
        feedbackEl.className = `fillin-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
        if (isCorrect) {
          feedbackEl.innerHTML = `
            <strong>‚úÖ Correct!</strong>
            ${explanation ? `<div class="fillin-explanation">${escapeHtml(explanation)}</div>` : ''}
          `;
          // Disable input on correct answer
          if (selectEl) selectEl.disabled = true;
          if (inputEl) inputEl.disabled = true;
          blankItem.querySelector('.fillin-check-btn').disabled = true;
        } else {
          // Check if out of tries (3 max)
          if (attempts >= 3) {
            // Show answer with explanation and review tip after 3 failed attempts
            feedbackEl.innerHTML = `
              <strong>‚ùå Out of tries!</strong>
              <div class="fillin-answer-reveal">
                <strong>Answer:</strong> <code>${escapeHtml(answer)}</code>
              </div>
              ${explanation ? `<div class="fillin-explanation">${escapeHtml(explanation)}</div>` : ''}
              ${reviewTip ? `<div class="fillin-review-tip">üìö ${escapeHtml(reviewTip)}</div>` : ''}
            `;
            // Disable input after 3 failed attempts
            if (selectEl) selectEl.disabled = true;
            if (inputEl) inputEl.disabled = true;
            blankItem.querySelector('.fillin-check-btn').disabled = true;
          } else {
            // Show hint with remaining tries
            const remainingTries = 3 - attempts;
            const hintText = hint || 'Think about what this part of the algorithm needs to accomplish.';
            feedbackEl.innerHTML = `
              <strong>‚ùå Not quite.</strong> <span class="fillin-tries-left">(${remainingTries} ${remainingTries === 1 ? 'try' : 'tries'} left)</span>
              <div class="fillin-hint-feedback">üí° Hint: ${escapeHtml(hintText)}</div>
            `;
          }
        }
        
        // Check if ALL blanks are resolved (correct or out of tries) to show AI Recommendation button
        const fillinContainer = blankItem.closest('.fillin-container');
        if (fillinContainer) {
          const allBlanks = fillinContainer.querySelectorAll('.fillin-blank-item');
          const allResolved = Array.from(allBlanks).every(item => {
            const checkBtn = item.querySelector('.fillin-check-btn');
            return checkBtn && checkBtn.disabled;
          });
          
          if (allResolved && !fillinContainer.querySelector('.ai-recommendation-btn')) {
            const recBtn = document.createElement('button');
            recBtn.className = 'ai-recommendation-btn';
            recBtn.innerHTML = 'ü§ñ AI Recommendation';
            recBtn.onclick = () => triggerAIRecommendation(fillinContainer, recBtn);
            fillinContainer.appendChild(recBtn);
          }
        }
      };

      // Trigger AI Recommendation based on fill-in-the-blank performance
      // Uses direct API call to render inline in the SAME widget (not via MCP/ChatGPT)
      const triggerAIRecommendation = async (fillinContainer, btn) => {
        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Generating recommendation...';
        
        // Gather performance data from all blanks
        const allBlanks = fillinContainer.querySelectorAll('.fillin-blank-item');
        const performanceData = Array.from(allBlanks).map((item, idx) => {
          const blankId = item.dataset.blankId || (idx + 1);
          const answer = item.dataset.answer || '';
          const attempts = parseInt(item.dataset.attempts || '0');
          const feedbackEl = item.querySelector('.fillin-feedback');
          const isCorrect = feedbackEl && feedbackEl.classList.contains('correct');
          const hintEl = item.querySelector('.fillin-hint');
          const usedHint = hintEl ? hintEl.classList.contains('visible') : false;
          const sawAnswer = attempts >= 3 && !isCorrect;
          
          return {
            blankId: blankId,
            correctAnswer: answer,
            attempts: attempts,
            gotCorrect: isCorrect,
            usedHint: usedHint,
            sawAnswer: sawAnswer
          };
        });
        
        // Get problem context
        const problemTitleEl = fillinContainer.querySelector('.fillin-problem-title');
        const problemDescEl = fillinContainer.querySelector('.fillin-problem-description');
        const problemTitle = problemTitleEl ? problemTitleEl.textContent.trim() : '';
        const problemDescription = problemDescEl ? problemDescEl.textContent.trim() : '';
        
        try {
          // Direct API call ‚Äî bypasses ChatGPT/MCP so the result renders in this widget
          const response = await fetch('https://algo-tutor.org/api/ai-recommendation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              performanceData: JSON.stringify(performanceData),
              problemTitle: problemTitle,
              problemDescription: problemDescription,
              topic: problemTitle, // use title as topic fallback
            })
          });
          
          const data = await response.json();
          
          if (!response.ok || data.error) {
            throw new Error(data.error || 'Failed to generate recommendation');
          }
          
          const outputs = data.recommendation || {};
          
          // Render recommendation inline in the same container
          btn.innerHTML = '‚úÖ Recommendation generated!';
          
          const recContainer = document.createElement('div');
          recContainer.className = 'ai-recommendation-container';
          recContainer.innerHTML = `<div class="ai-recommendation-title">ü§ñ AI Study Recommendation</div>`;
          
          const addRecSection = (title, items) => {
            if (!items || (Array.isArray(items) && items.length === 0)) return;
            const sectionEl = document.createElement('div');
            sectionEl.className = 'ai-recommendation-section';
            sectionEl.innerHTML = `
              <div class="ai-recommendation-section-title">${escapeHtml(title)}</div>
              <div class="ai-recommendation-section-content">${
                Array.isArray(items)
                  ? '<ul>' + items.map(p => `<li>${escapeHtml(p)}</li>`).join('') + '</ul>'
                  : escapeHtml(String(items)).replace(/\n/g, '<br>')
              }</div>
            `;
            recContainer.appendChild(sectionEl);
          };
          
          addRecSection('üìö What to Study', outputs.whatToStudy);
          addRecSection('üîç Pattern Recognition Tips', outputs.patternTips);
          addRecSection('üéØ Practice Strategy', outputs.practiceStrategy);
          addRecSection('üí° Key Takeaways', outputs.keyTakeaways);
          
          if (outputs.encouragement) {
            const encEl = document.createElement('div');
            encEl.className = 'ai-recommendation-section';
            encEl.innerHTML = `
              <div style="padding: 10px 14px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981; font-size: 0.85rem; line-height: 1.6;">
                üí™ ${escapeHtml(outputs.encouragement)}
              </div>
            `;
            recContainer.appendChild(encEl);
          }
          
          // Insert recommendation after the button in the same widget
          fillinContainer.appendChild(recContainer);
          
        } catch (err) {
          console.error('[Widget] AI recommendation failed:', err);
          btn.innerHTML = 'ü§ñ AI Recommendation';
          btn.disabled = false;
          
          // Show inline error message
          const errEl = document.createElement('div');
          errEl.style.cssText = 'color: #ef4444; font-size: 0.8rem; margin-top: 8px;';
          errEl.textContent = 'Failed to generate recommendation. Please try again.';
          btn.parentNode.insertBefore(errEl, btn.nextSibling);
          setTimeout(() => errEl.remove(), 5000);
        }
      };

      // Form submissions
      modeForms.learn.addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusEl = document.querySelector("#learn-status");

        const topic = document.querySelector("#learn-topic").value.trim();
        const difficulty = document.querySelector("#learn-difficulty").value;
        const depth = document.querySelector("#learn-depth").value;
        const exampleSize = document.querySelector("#learn-example-size").value;

        if (!topic) {
          statusEl.textContent = "Please enter a pattern/topic.";
          return;
        }

        statusEl.textContent = "Generating lesson...";
        
        // Build natural language prompt for ChatGPT - Learn Mode (simplified)
        let prompt = `Use AlgoTutor Learn Mode to teach me ${topic} with ${difficulty} difficulty and ${depth} depth.`;
        prompt += ` Use ${exampleSize} example size.`;

        try {
          await sendFollowUp(prompt);
          statusEl.textContent = "‚úÖ Request sent!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      });

      modeForms.build.addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusEl = document.querySelector("#build-status");

        const problem = document.querySelector("#build-problem").value.trim();
        const language = document.querySelector("#build-language").value;
        const allowRecursion = document.querySelector("#build-recursion").checked;
        const minimalCode = document.querySelector("#build-minimal-code").checked;

        if (!problem) {
          statusEl.textContent = "Please enter a problem.";
          return;
        }

        // Store problem for Build Mode follow-ups
        currentBuildProblem = problem;
        // Reset follow-up tracking for new Build Mode submission
        currentBuildCode = '';
        currentBuildTestCases = '';
        currentBuildConstraints = '';
        buildTraceHasBeenUsed = false;
        buildExplainHasBeenUsed = false;
        lastBuildResponse = null;

        statusEl.textContent = "Building solution...";
        
        // Build natural language prompt for ChatGPT - Build Mode
        // Test cases and constraints are now detected from the problem description by the LLM
        let prompt = `Use AlgoTutor Build Mode to solve this problem in ${language}: ${problem}.`;
        prompt += minimalCode ? ` Use minimal paper-friendly code.` : ` Include helpful comments in code.`;
        prompt += allowRecursion ? ` Recursion is allowed.` : ` Do NOT use recursion - use iterative solutions only.`;

        try {
          await sendFollowUp(prompt);
          statusEl.textContent = "‚úÖ Request sent!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      });

      modeForms.debug.addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusEl = document.querySelector("#debug-status");

        const code = document.querySelector("#debug-code").value.trim();
        const language = document.querySelector("#debug-language").value;

        if (!code) {
          statusEl.textContent = "Please paste your code.";
          return;
        }

        // Store the code and language for follow-up questions
        currentDebugCode = code;
        currentDebugLanguage = language;
        currentDebugProblem = ''; // Will be populated from response
        currentDebugTopic = ''; // Will be populated from response
        lastDebugResponse = null;

        statusEl.textContent = "Debugging code...";
        
        // Build natural language prompt for ChatGPT - Debug Mode
        const prompt = `Use AlgoTutor Debug Mode to debug this ${language} code.\n\nCode:\n\`\`\`${language}\n${code}\n\`\`\``;

        try {
          await sendFollowUp(prompt);
          statusEl.textContent = "‚úÖ Request sent!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      });

      // Helper: Try to extract outputs from various formats
      function extractOutputs(data) {
        console.log("[Widget] extractOutputs called with:", typeof data, data);
        
        // If data is a string, try to parse it as JSON
        if (typeof data === 'string') {
          try {
            data = JSON.parse(data);
            console.log("[Widget] Parsed JSON string:", data);
          } catch (e) {
            console.log("[Widget] Not valid JSON string");
            return null;
          }
        }
        
        if (!data) return null;
        
        // Direct outputs object
        if (data.outputs) {
          console.log("[Widget] Found outputs directly");
          return data.outputs;
        }
        
        // If data itself looks like outputs (has pattern, stepByStep, etc.)
        if (data.pattern || data.stepByStep || data.code) {
          console.log("[Widget] Data looks like outputs itself");
          return data;
        }
        
        // toolOutput wrapper
        if (data.toolOutput?.outputs) {
          console.log("[Widget] Found outputs in toolOutput");
          return data.toolOutput.outputs;
        }
        
        // result wrapper
        if (data.result?.outputs) {
          console.log("[Widget] Found outputs in result");
          return data.result.outputs;
        }
        
        // Nested result.toolOutput
        if (data.result?.toolOutput?.outputs) {
          console.log("[Widget] Found outputs in result.toolOutput");
          return data.result.toolOutput.outputs;
        }
        
        return null;
      }

      // Helper: Extract logId from response for feedback tracking
      function extractLogId(data) {
        if (!data) return null;
        
        // If data is a string, try to parse it as JSON
        if (typeof data === 'string') {
          try {
            data = JSON.parse(data);
          } catch (e) {
            return null;
          }
        }
        
        // Direct logId
        if (data.logId) return data.logId;
        
        // toolOutput wrapper
        if (data.toolOutput?.logId) return data.toolOutput.logId;
        
        // In text field (MCP format)
        if (data.toolOutput?.text) {
          try {
            const parsed = JSON.parse(data.toolOutput.text);
            if (parsed.logId) return parsed.logId;
          } catch (e) {}
        }
        
        // content[0].text (MCP format)
        if (data.content?.[0]?.text) {
          try {
            const parsed = JSON.parse(data.content[0].text);
            if (parsed.logId) return parsed.logId;
          } catch (e) {}
        }
        
        return null;
      }

      // Helper: Check for errors with upgrade URL
      function extractError(data) {
        console.log("[Widget] extractError called with:", typeof data, data);
        
        if (typeof data === 'string') {
          try {
            data = JSON.parse(data);
            console.log("[Widget] extractError: parsed JSON string to:", data);
          } catch (e) {
            console.log("[Widget] extractError: not valid JSON string");
            return null;
          }
        }
        
        if (!data) return null;
        
        // Check direct error (new format: error is at root level of parsed JSON)
        if (data.error) {
          console.log("[Widget] ‚úÖ extractError: found error at data.error:", data.error);
          return data.error;
        }
        
        // Check toolOutput.error
        if (data.toolOutput?.error) {
          console.log("[Widget] ‚úÖ extractError: found error at data.toolOutput.error:", data.toolOutput.error);
          return data.toolOutput.error;
        }
        
        // Check result.error
        if (data.result?.error) {
          console.log("[Widget] ‚úÖ extractError: found error at data.result.error:", data.result.error);
          return data.result.error;
        }
        
        // Check toolOutput.text (might contain JSON with error)
        if (data.toolOutput?.text) {
          console.log("[Widget] extractError: checking data.toolOutput.text");
          return extractError(data.toolOutput.text);
        }
        
        // Check content[0].text (MCP format)
        if (data.content?.[0]?.text) {
          console.log("[Widget] extractError: checking data.content[0].text");
          return extractError(data.content[0].text);
        }
        
        console.log("[Widget] extractError: no error found");
        return null;
      }

      // Helper: Format remaining time for countdown
      function formatCountdown(expiresAt) {
        const now = Date.now();
        const expires = new Date(expiresAt).getTime();
        const remaining = expires - now;
        
        if (remaining <= 0) return null; // Expired
        
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        
        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        }
        return `${minutes}m`;
      }

      // Render error with upgrade button
      function renderError(error) {
        console.log("[Widget] ==================== renderError ====================");
        console.log("[Widget] Rendering error:", JSON.stringify(error, null, 2));
        outputContainer.innerHTML = '';
        
        // Store cooldown expiry in localStorage if present
        if (error.cooldownExpiresAt) {
          localStorage.setItem('algotutor_cooldown_expires', error.cooldownExpiresAt);
          console.log("[Widget] Stored cooldown expires at:", error.cooldownExpiresAt);
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'upgrade-container';
        
        // Error icon
        const iconDiv = document.createElement('div');
        iconDiv.style.fontSize = '3rem';
        iconDiv.style.marginBottom = '16px';
        iconDiv.textContent = '‚ö†Ô∏è';
        errorDiv.appendChild(iconDiv);
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'upgrade-message';
        messageDiv.textContent = error.message || 'An error occurred.';
        errorDiv.appendChild(messageDiv);
        
        // Show countdown timer if cooldown is active
        if (error.cooldownExpiresAt) {
          const countdownDiv = document.createElement('div');
          countdownDiv.id = 'cooldown-timer';
          countdownDiv.style.marginTop = '12px';
          countdownDiv.style.padding = '8px 16px';
          countdownDiv.style.background = 'rgba(59, 130, 246, 0.1)';
          countdownDiv.style.borderRadius = '8px';
          countdownDiv.style.color = 'var(--accent)';
          countdownDiv.style.fontSize = '0.9rem';
          countdownDiv.style.fontWeight = '500';
          
          const updateCountdown = () => {
            const formatted = formatCountdown(error.cooldownExpiresAt);
            if (formatted) {
              countdownDiv.textContent = `‚è±Ô∏è Try again in ${formatted}`;
            } else {
              countdownDiv.textContent = '‚úÖ You can try again now!';
              countdownDiv.style.background = 'rgba(16, 185, 129, 0.1)';
              countdownDiv.style.color = '#10b981';
              localStorage.removeItem('algotutor_cooldown_expires');
            }
          };
          
          updateCountdown();
          // Update every minute
          const intervalId = setInterval(updateCountdown, 60000);
          // Store interval ID so we can clear it later
          countdownDiv.dataset.intervalId = intervalId;
          
          errorDiv.appendChild(countdownDiv);
        }
        
        if (error.upgradeUrl) {
          console.log("[Widget] ‚úÖ upgradeUrl found, creating button:", error.upgradeUrl);
          
          // Add some spacing
          const spacer = document.createElement('div');
          spacer.style.marginBottom = '20px';
          errorDiv.appendChild(spacer);
          
          const upgradeBtn = document.createElement('button');
          upgradeBtn.className = 'upgrade-btn';
          upgradeBtn.textContent = '‚ö° Upgrade to Premium';
          upgradeBtn.onclick = () => {
            console.log("[Widget] Upgrade button clicked, opening:", error.upgradeUrl);
            window.open(error.upgradeUrl, '_blank');
          };
          errorDiv.appendChild(upgradeBtn);
          
          // Add a note below the button
          const noteDiv = document.createElement('p');
          noteDiv.style.marginTop = '16px';
          noteDiv.style.color = 'var(--text-muted)';
          noteDiv.style.fontSize = '0.85rem';
          noteDiv.textContent = 'Get unlimited access to all AlgoTutor modes!';
          errorDiv.appendChild(noteDiv);
          
          // Add early adopter promo banner
          const promoBanner = document.createElement('div');
          promoBanner.className = 'promo-banner';
          promoBanner.innerHTML = `
            <div class="promo-banner-title">üéâ Early Access: 30%+ OFF!</div>
            <p class="promo-banner-text">
              Get premium now at <strong>$9.99/mo</strong>.
              Plus, <strong>early access to personalized exam prep</strong> coming soon.
              Guaranteed to help with any CS class exam.
            </p>
          `;
          errorDiv.appendChild(promoBanner);
        } else {
          console.warn("[Widget] ‚ö†Ô∏è No upgradeUrl in error object");
        }
        
        outputContainer.appendChild(errorDiv);
        console.log("[Widget] ‚úÖ Error rendered with upgrade container");
      }

      // Listen for state updates from ChatGPT
      window.addEventListener("openai:set_globals", (ev) => {
        console.log("[Widget] ==================== openai:set_globals ====================");
        console.log("[Widget] Event detail:", JSON.stringify(ev.detail, null, 2));
        
        const detail = ev.detail || {};
        const g = detail.globals || detail.state || detail;
        console.log("[Widget] Extracted globals:", JSON.stringify(g, null, 2));
        
        // Check for errors first (including upgrade prompts)
        // Try multiple possible locations
        console.log("[Widget] Checking for errors...");
        let error = extractError(g);
        if (!error && g?.toolOutput) {
          error = extractError(g.toolOutput);
        }
        if (!error && g?.toolOutput?.text) {
          error = extractError(g.toolOutput.text);
        }
        if (!error && g?.content?.[0]?.text) {
          error = extractError(g.content[0].text);
        }
        
        if (error) {
          console.log("[Widget] ‚ö†Ô∏è Found error in response:", error);
          renderError(error);
          return;
        }
        
        // Try to extract logId for feedback tracking
        currentLogId = extractLogId(g) || extractLogId(g?.toolOutput) || extractLogId(g?.content?.[0]?.text);
        console.log("[Widget] Extracted logId from globals:", currentLogId);
        
        // Try to extract outputs from various locations
        let outputs = null;
        
        // Try toolOutput first
        outputs = extractOutputs(g?.toolOutput);
        
        // Try toolOutput.text (MCP format - JSON string)
        if (!outputs && g?.toolOutput?.text) {
          console.log("[Widget] Trying to parse toolOutput.text as JSON");
          outputs = extractOutputs(g.toolOutput.text);
        }
        
        // Try content[0].text (MCP format)
        if (!outputs && g?.content?.[0]?.text) {
          console.log("[Widget] Trying to parse content[0].text as JSON");
          outputs = extractOutputs(g.content[0].text);
        }
        
        // Try widget.props.text
        if (!outputs && g?.widget?.props?.text) {
          console.log("[Widget] Trying to parse widget.props.text as JSON");
          outputs = extractOutputs(g.widget.props.text);
        }
        
        // Try widgetState
        if (!outputs) {
          outputs = extractOutputs(g?.widgetState);
        }
        
        if (outputs) {
          console.log("[Widget] ‚úÖ Found outputs, rendering:", JSON.stringify(outputs, null, 2));
          currentState = { outputs };
          renderOutputs(outputs);
        } else {
          console.warn("[Widget] ‚ùå No outputs found in any location");
        }
      });

      window.addEventListener("openai:state_updated", (ev) => {
        console.log("[Widget] ==================== openai:state_updated ====================");
        console.log("[Widget] Event detail:", JSON.stringify(ev.detail, null, 2));
        
        const s = ev.detail?.state || ev.detail;
        if (!s) {
          console.warn("[Widget] No state in event detail");
          return;
        }
        
        // Check for errors first (including upgrade prompts)
        console.log("[Widget] Checking for errors in state_updated...");
        let error = extractError(s);
        if (!error && s.toolOutput) error = extractError(s.toolOutput);
        if (!error && s.toolOutput?.text) error = extractError(s.toolOutput.text);
        if (!error && s.content?.[0]?.text) error = extractError(s.content[0].text);
        if (error) {
          console.log("[Widget] ‚ö†Ô∏è Found error in state_updated:", error);
          renderError(error);
          return;
        }
        
        // Try to extract logId for feedback tracking
        currentLogId = extractLogId(s) || extractLogId(s.toolOutput) || extractLogId(s.content?.[0]?.text);
        console.log("[Widget] Extracted logId:", currentLogId);
        
        // Try to extract outputs from various locations
        let outputs = extractOutputs(s);
        
        if (!outputs) {
          outputs = extractOutputs(s.toolOutput);
        }
        
        if (!outputs && s.toolOutput?.text) {
          outputs = extractOutputs(s.toolOutput.text);
        }
        
        if (!outputs && s.content?.[0]?.text) {
          outputs = extractOutputs(s.content[0].text);
        }
        
        if (outputs) {
          console.log("[Widget] ‚úÖ Rendering outputs from state_updated:", JSON.stringify(outputs, null, 2));
          currentState = { outputs };
          renderOutputs(outputs);
        } else {
          console.warn("[Widget] ‚ùå No outputs found in state");
        }
      });

      // Initial render
      console.log("[Widget] ==================== INITIAL RENDER ====================");
      console.log("[Widget] currentState:", JSON.stringify(currentState, null, 2));
      console.log("[Widget] currentState.outputs exists?", !!currentState.outputs);
      
      if (currentState.outputs) {
        console.log("[Widget] üéØ Calling renderOutputs with initial state");
        renderOutputs(currentState.outputs);
      } else {
        console.warn("[Widget] ‚ö†Ô∏è No initial outputs found - not calling renderOutputs");
      }
      
      console.log("[Widget] ==================== INITIALIZATION COMPLETE ====================");

      // ==================== AUTO-ACTIVATE PREMIUM FROM LOCALSTORAGE ====================
      // EARLY_ACCESS_START: Auto-activation disabled during early access
      let storedPremiumCode = null;
      if (!EARLY_ACCESS_MODE) {
        // Check if user has a stored premium code and auto-activate it for this session
        storedPremiumCode = localStorage.getItem('algotutor_premium_code');
        const cancelBtn = document.getElementById('cancel-subscription-btn');
        const currentWidgetId = getChatGPTUserId(); // Get widget ID for device binding
        
        if (storedPremiumCode) {
          console.log('[Widget] Found stored premium code, auto-activating:', storedPremiumCode, 'widgetId:', currentWidgetId);
          
          // Show cancel button since user has a stored code
          if (cancelBtn) {
            cancelBtn.style.display = 'inline-block';
          }
          
          // Auto-activate in background (don't block UI)
          // Include widgetId to verify this device is the one that claimed the code
          fetch('https://algo-tutor.org/api/activate-premium', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: storedPremiumCode, widgetId: currentWidgetId })
          })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.log('[Widget] Auto-activation failed:', data.error);
              // If code is invalid, revoked, or claimed by another device, remove it from storage
              if (data.error.includes('Invalid') || data.error.includes('not found') || data.error.includes('revoked') || data.error.includes('another device')) {
                localStorage.removeItem('algotutor_premium_code');
                console.log('[Widget] Removed invalid/revoked/claimed code from localStorage');
                // Hide cancel button since code is no longer valid
                if (cancelBtn) {
                  cancelBtn.style.display = 'none';
                }
              }
            } else {
              console.log('[Widget] ‚úì Auto-activation successful! Premium status restored.');
              // Update the activate button to show premium is active
              const activateBtn = document.getElementById('activate-premium-btn');
              if (activateBtn) {
                activateBtn.textContent = '‚úì Premium Active';
                activateBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                activateBtn.disabled = true;
              }
            }
          })
          .catch(error => {
            console.error('[Widget] Auto-activation error:', error);
          });
        } else {
          console.log('[Widget] No stored premium code found');
          // Hide cancel button if no code stored
          if (cancelBtn) {
            cancelBtn.style.display = 'none';
          }
        }
        
        // Cancel subscription button click handler
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => {
            console.log('[Widget] Opening cancel subscription page');
            window.open('https://algo-tutor.org/cancel.html', '_blank');
          });
        }
      } else {
        console.log('[Widget] Early access mode - premium auto-activation disabled');
      }
      // EARLY_ACCESS_END

      // ==================== CHECK COOLDOWN FROM LOCALSTORAGE ====================
      // EARLY_ACCESS: Cooldown checking disabled during early access - unlimited usage
      const storedCooldown = localStorage.getItem('algotutor_cooldown_expires');
      if (!EARLY_ACCESS_MODE && storedCooldown && !storedPremiumCode) {
        const now = Date.now();
        const expires = new Date(storedCooldown).getTime();
        const remaining = expires - now;
        
        if (remaining > 0) {
          console.log('[Widget] Active cooldown found, expires at:', storedCooldown);
          // Don't show cooldown UI on init - it will show when user tries to use the tool
          // Just log that we have an active cooldown
        } else {
          // Cooldown expired, clean up localStorage
          localStorage.removeItem('algotutor_cooldown_expires');
          console.log('[Widget] Cooldown expired, removed from localStorage');
        }
      }

      // ==================== PREMIUM ACTIVATION MODAL ====================
      // EARLY_ACCESS_START: Premium activation code - disabled during early access
      if (!EARLY_ACCESS_MODE) {
        const premiumModal = document.getElementById('premium-modal');
        const activatePremiumBtn = document.getElementById('activate-premium-btn');
        const modalCancel = document.getElementById('modal-cancel');
        const modalActivate = document.getElementById('modal-activate');
        const premiumCodeInput = document.getElementById('premium-code-input');
        const modalMessage = document.getElementById('modal-message');

        // Open modal
        activatePremiumBtn.addEventListener('click', () => {
          premiumModal.classList.add('active');
          premiumCodeInput.value = '';
          modalMessage.style.display = 'none';
          premiumCodeInput.focus();
        });

        // Close modal
        modalCancel.addEventListener('click', () => {
          premiumModal.classList.remove('active');
        });

        // Close on overlay click
        premiumModal.addEventListener('click', (e) => {
          if (e.target === premiumModal) {
            premiumModal.classList.remove('active');
          }
        });
      } else {
        console.log('[Widget] Early access mode - premium activation disabled');
      }
      // EARLY_ACCESS_END

      // ==================== HELP MODAL ====================
      const helpModal = document.getElementById('help-modal');
      const helpBtn = document.getElementById('help-btn');
      const helpModalClose = document.getElementById('help-modal-close');

      // Open help modal
      helpBtn.addEventListener('click', () => {
        helpModal.classList.add('active');
      });

      // Close help modal
      helpModalClose.addEventListener('click', () => {
        helpModal.classList.remove('active');
      });

      // Close on overlay click
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) {
          helpModal.classList.remove('active');
        }
      });

      // Format input as user types
      // EARLY_ACCESS_START: Premium code input formatting - disabled during early access
      if (!EARLY_ACCESS_MODE) {
        const premiumCodeInput = document.getElementById('premium-code-input');
        if (premiumCodeInput) {
          premiumCodeInput.addEventListener('input', (e) => {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            // Auto-add ALGO- prefix if not present
            if (value.length > 0 && !value.startsWith('ALGO-') && !value.startsWith('A')) {
              value = 'ALGO-' + value;
            }
            e.target.value = value;
          });
        }
      }
      // EARLY_ACCESS_END

      // Helper to get chatgpt user ID (from context or generate one based on session)
      function getChatGPTUserId() {
        // Try to get from OpenAI context
        const openaiContext = window.openai || {};
        if (openaiContext.userId) return openaiContext.userId;
        if (openaiContext.subject) return openaiContext.subject;
        
        // Fallback: generate/get from localStorage
        let storedId = localStorage.getItem('algotutor_user_id');
        if (!storedId) {
          storedId = 'widget-' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('algotutor_user_id', storedId);
        }
        return storedId;
      }

      // ==================== REGISTER SESSION FOR FREE TIER TRACKING ====================
      // Register this widget session with the server so usage can be tracked across IP changes
      // This runs on every widget load to keep the session linked
      (async function registerSession() {
        const widgetId = getChatGPTUserId();
        console.log('[Widget] Registering session with widget ID:', widgetId);
        
        try {
          const response = await fetch('https://algo-tutor.org/api/register-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ widgetId })
          });
          
          const data = await response.json();
          if (data.success) {
            console.log('[Widget] ‚úì Session registered successfully');
          } else {
            console.log('[Widget] Session registration response:', data);
          }
        } catch (error) {
          console.error('[Widget] Session registration error:', error);
          // Non-critical error - don't block widget functionality
        }
      })();

      // Activate premium
      // EARLY_ACCESS_START: Premium activation handler - disabled during early access
      if (!EARLY_ACCESS_MODE) {
        const modalActivate = document.getElementById('modal-activate');
        const premiumCodeInput = document.getElementById('premium-code-input');
        const modalMessage = document.getElementById('modal-message');
        const premiumModal = document.getElementById('premium-modal');
        const activatePremiumBtn = document.getElementById('activate-premium-btn');
        
        if (modalActivate && premiumCodeInput) {
          modalActivate.addEventListener('click', async () => {
            const code = premiumCodeInput.value.trim().toUpperCase();
            
            if (!code || code.length < 5) {
              modalMessage.textContent = 'Please enter a valid activation code.';
              modalMessage.className = 'modal-message error';
              modalMessage.style.display = 'block';
              return;
            }

            modalActivate.disabled = true;
            modalActivate.textContent = 'Activating...';

            try {
              // Get widget ID for device binding - this binds the code to this specific device
              const widgetId = getChatGPTUserId();
              console.log('[Widget] Activating premium with widgetId:', widgetId);
              
              const response = await fetch('https://algo-tutor.org/api/activate-premium', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  code: code,
                  widgetId: widgetId
                })
              });

              const data = await response.json();

              if (data.error) {
                modalMessage.textContent = data.error;
                modalMessage.className = 'modal-message error';
                modalMessage.style.display = 'block';
              } else {
                modalMessage.textContent = '‚úì ' + (data.message || 'Premium activated successfully!');
                modalMessage.className = 'modal-message success';
                modalMessage.style.display = 'block';
                
                // Store the code in localStorage for cross-session persistence
                localStorage.setItem('algotutor_premium_code', code);
                console.log('[Widget] Premium code stored in localStorage:', code);
                
                // Show cancel button now that user has activated premium
                const cancelBtn = document.getElementById('cancel-subscription-btn');
                if (cancelBtn) {
                  cancelBtn.style.display = 'inline-block';
                }
                
                // Close modal after brief delay
                setTimeout(() => {
                  premiumModal.classList.remove('active');
                  
                  // Update the activate button to show premium is active
                  activatePremiumBtn.textContent = '‚úì Premium Active';
                  activatePremiumBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                  activatePremiumBtn.disabled = true;
                  
                  // Clear any error display and show success state in the output container
                  outputContainer.innerHTML = `
                    <div class="premium-success-container">
                      <div class="premium-success-icon">üéâ</div>
                      <div class="premium-success-title">Premium Activated!</div>
                      <div class="premium-success-message">
                        Your account now has unlimited access to all AlgoTutor modes.
                      </div>
                      <div class="premium-success-hint">
                        Begin interacting with AlgoTutor widget to start learning with premium access!
                      </div>
                      <div class="premium-success-hint" style="margin-top: 12px; background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                        üìä Forgot your code? Visit <strong>algo-tutor.org</strong> and sign in to recover it anytime.
                      </div>
                    </div>
                  `;
                }, 1500);
              }
            } catch (error) {
              console.error('Activation error:', error);
              modalMessage.textContent = 'Failed to activate. Please try again.';
              modalMessage.className = 'modal-message error';
              modalMessage.style.display = 'block';
            }

            modalActivate.disabled = false;
            modalActivate.textContent = 'Activate';
          });

          // Handle Enter key in input
          premiumCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              modalActivate.click();
            }
          });
        }
      }
      // EARLY_ACCESS_END

      // ==================== FEEDBACK SYSTEM ====================
      const feedbackModal = document.getElementById('feedback-modal');
      const feedbackModalTitle = document.getElementById('feedback-modal-title');
      const feedbackOptions = document.getElementById('feedback-options');
      const feedbackModalSkip = document.getElementById('feedback-modal-skip');
      
      // Feedback options
      const positiveOptions = [
        { value: 'clear_explanation', label: 'Clear explanation' },
        { value: 'good_examples', label: 'Good examples' },
        { value: 'helped_understand', label: 'Helped me understand' },
        { value: 'easy_code', label: 'Code was easy to follow' }
      ];
      
      const negativeOptions = [
        { value: 'unclear', label: 'Explanation unclear' },
        { value: 'too_advanced', label: 'Too advanced' },
        { value: 'already_knew', label: 'Already knew this' },
        { value: 'code_broken', label: "Code didn't work" }
      ];
      
      let pendingFeedbackDecision = null;
      
      // Show feedback modal with appropriate options
      function showFeedbackModal(decision) {
        pendingFeedbackDecision = decision;
        const options = decision === 'yes' ? positiveOptions : negativeOptions;
        const title = decision === 'yes' ? 'What did you like?' : 'What was wrong?';
        
        feedbackModalTitle.textContent = title;
        feedbackOptions.innerHTML = '';
        
        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'feedback-option-btn';
          btn.textContent = opt.label;
          btn.dataset.value = opt.value;
          btn.addEventListener('click', () => submitFeedback(decision, opt.value));
          feedbackOptions.appendChild(btn);
        });
        
        feedbackModal.classList.add('active');
      }
      
      // Submit feedback to API
      async function submitFeedback(decision, reason) {
        console.log('[Feedback] Submitting:', { logId: currentLogId, decision, reason });
        
        // Close modal immediately for good UX
        feedbackModal.classList.remove('active');
        
        // Update the feedback container to show thanks
        const feedbackContainer = document.getElementById('feedback-container');
        if (feedbackContainer) {
          feedbackContainer.innerHTML = `<div class="feedback-thanks">Thanks for your feedback! üéâ</div>`;
        }
        
        if (!currentLogId) {
          console.warn('[Feedback] No logId available, cannot submit');
          return;
        }
        
        try {
          const widgetId = getChatGPTUserId();
          const response = await fetch('https://algo-tutor.org/api/submit-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              logId: currentLogId,
              decision: decision,
              reason: reason,
              widgetId: widgetId
            })
          });
          
          const data = await response.json();
          if (data.success) {
            console.log('[Feedback] ‚úì Feedback submitted successfully');
          } else {
            console.error('[Feedback] Failed to submit:', data.error);
          }
        } catch (error) {
          console.error('[Feedback] Error submitting feedback:', error);
        }
      }
      
      // Handle feedback button clicks (using event delegation)
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('feedback-btn')) {
          const decision = e.target.dataset.decision;
          console.log('[Feedback] Button clicked:', decision);
          showFeedbackModal(decision);
        }
      });
      
      // Skip button - just close modal and show thanks
      feedbackModalSkip.addEventListener('click', () => {
        feedbackModal.classList.remove('active');
        
        // Optionally submit without reason
        if (pendingFeedbackDecision && currentLogId) {
          submitFeedback(pendingFeedbackDecision, null);
        }
      });
      
      // Close modal on overlay click
      feedbackModal.addEventListener('click', (e) => {
        if (e.target === feedbackModal) {
          feedbackModal.classList.remove('active');
        }
      });

      // ==================== FOLLOW-UP BUTTON HANDLERS (Learn Mode & Build Mode) ====================
      document.addEventListener('click', async (e) => {
        const followupBtn = e.target.closest('.followup-btn');
        if (!followupBtn) return;
        
        const action = followupBtn.dataset.action;
        const topic = followupBtn.dataset.topic || currentLearnTopic;
        const code = followupBtn.dataset.code || currentLearnCode;
        
        console.log('[Widget] Follow-up button clicked:', action, 'topic:', topic);
        console.log('[Widget] currentBuildCode:', currentBuildCode ? 'SET' : 'EMPTY');
        console.log('[Widget] buildTraceHasBeenUsed:', buildTraceHasBeenUsed, 'buildExplainHasBeenUsed:', buildExplainHasBeenUsed);
        
        // Disable button to prevent double-clicks
        followupBtn.disabled = true;
        followupBtn.style.opacity = '0.6';
        const originalText = followupBtn.querySelector('.followup-btn-text').textContent;
        followupBtn.querySelector('.followup-btn-text').textContent = 'Loading...';
        
        // Helper to restore button state
        const restoreButton = () => {
          followupBtn.disabled = false;
          followupBtn.style.opacity = '1';
          followupBtn.querySelector('.followup-btn-text').textContent = originalText;
        };
        
        try {
          let prompt;
          
          // === BUILD MODE ACTIONS (check first - don't depend on topic) ===
          if (action === 'build-trace-walkthrough') {
            if (!currentBuildCode) {
              console.warn('[Widget] No build code available for trace/walkthrough');
              restoreButton();
              return;
            }
            
            // Use edge case if trace has been used before
            const isEdgeCase = buildTraceHasBeenUsed;
            buildTraceHasBeenUsed = true; // Mark as used for next time
            
            prompt = `Use AlgoTutor build_trace_walkthrough tool to show a dry-run table and example walkthrough.`;
            prompt += ` isEdgeCase: ${isEdgeCase}.`;
            prompt += ` Code: \`\`\`\n${currentBuildCode}\n\`\`\``;
            if (currentBuildProblem) {
              prompt += ` Problem: ${currentBuildProblem}`;
            }
            if (currentBuildTestCases) {
              prompt += ` Test cases detected: ${currentBuildTestCases}`;
            }
            if (currentBuildConstraints) {
              prompt += ` Constraints: ${currentBuildConstraints}`;
            }
            // Include last response context if available
            if (lastBuildResponse && lastBuildResponse.exampleWalkthrough) {
              prompt += ` Previous walkthrough context: ${lastBuildResponse.exampleWalkthrough.substring(0, 500)}`;
            }
          } else if (action === 'build-explain-simple') {
            if (!currentBuildCode) {
              console.warn('[Widget] No build code available for explanation');
              restoreButton();
              return;
            }
            
            buildExplainHasBeenUsed = true; // Mark as used for next time
            
            prompt = `Use AlgoTutor build_explain_simple tool to explain the solution more clearly.`;
            prompt += ` Code: \`\`\`\n${currentBuildCode}\n\`\`\``;
            if (currentBuildProblem) {
              prompt += ` Problem: ${currentBuildProblem}`;
            }
            // Include last response context for context-aware explanations
            if (lastBuildResponse) {
              if (lastBuildResponse.exampleWalkthrough) {
                prompt += ` Explain this walkthrough more clearly: ${lastBuildResponse.exampleWalkthrough.substring(0, 500)}`;
              } else if (lastBuildResponse.detailedExplanation) {
                prompt += ` Build on this explanation: ${lastBuildResponse.detailedExplanation.substring(0, 500)}`;
              }
            }
          }
          // === DEBUG MODE ACTIONS ===
          // Read context from data-attributes (embedded on buttons) to work across widget instances
          else if (action === 'debug-trace-walkthrough') {
            // Read from data-attributes first (for new widget instances), fall back to global state
            const debugCode = followupBtn.dataset.code || currentDebugCode;
            const debugLanguage = followupBtn.dataset.language || currentDebugLanguage || 'python';
            const debugProblem = followupBtn.dataset.problem || currentDebugProblem;
            
            if (!debugCode) {
              console.warn('[Widget] No debug code available for trace/walkthrough');
              restoreButton();
              return;
            }
            
            prompt = `Use AlgoTutor debug_trace_walkthrough tool to show a trace table and example walkthrough.`;
            prompt += ` Code: \`\`\`${debugLanguage}\n${debugCode}\n\`\`\``;
            prompt += ` Language: ${debugLanguage}`;
            if (debugProblem) {
              prompt += ` Problem context: ${debugProblem}`;
            }
            console.log('[Widget] Debug trace walkthrough - code length:', debugCode.length);
          } else if (action === 'debug-similar-problem') {
            // Read from data-attributes first (for new widget instances), fall back to global state
            const debugCode = followupBtn.dataset.code || currentDebugCode;
            const debugLanguage = followupBtn.dataset.language || currentDebugLanguage || 'python';
            const debugProblem = followupBtn.dataset.problem || currentDebugProblem;
            const debugTopic = followupBtn.dataset.topic || currentDebugTopic;
            const debugBugInfo = followupBtn.dataset.bugInfo || currentDebugBugInfo;
            
            if (!debugCode) {
              console.warn('[Widget] No debug code available for similar problem');
              restoreButton();
              return;
            }
            
            prompt = `Use AlgoTutor debug_similar_problem tool to generate a fill-in-the-blank practice problem.`;
            prompt += ` Code: \`\`\`${debugLanguage}\n${debugCode}\n\`\`\``;
            prompt += ` Language: ${debugLanguage}`;
            if (debugProblem) {
              prompt += ` Problem context: ${debugProblem}`;
            }
            if (debugTopic) {
              prompt += ` Topic/pattern: ${debugTopic}`;
            }
            if (debugBugInfo) {
              prompt += ` Bug info (focus blanks on this issue type): ${debugBugInfo}`;
            }
            console.log('[Widget] Debug similar problem - code length:', debugCode.length, 'topic:', debugTopic);
          }
          // === LEARN MODE ACTIONS ===
          else if (action === 'trace-walkthrough') {
            if (!topic) {
              console.warn('[Widget] No topic available for follow-up');
              restoreButton();
              return;
            }
            prompt = `Use AlgoTutor learn_trace_walkthrough tool to show me a trace table and example walkthrough for ${topic}.`;
            if (code) {
              prompt += ` Use this code as reference: \`\`\`python\n${code}\n\`\`\``;
            }
          } else if (action === 'real-world') {
            if (!topic) {
              console.warn('[Widget] No topic available for follow-up');
              restoreButton();
              return;
            }
            prompt = `Use AlgoTutor learn_real_world_example tool to generate a fill-in-the-blank practice problem for ${topic}.`;
          }
          
          if (prompt) {
            console.log('[Widget] Sending follow-up prompt:', prompt.substring(0, 100) + '...');
            await sendFollowUp(prompt);
            console.log('[Widget] Follow-up request sent successfully');
          } else {
            console.warn('[Widget] No prompt generated for action:', action);
            restoreButton();
          }
        } catch (err) {
          console.error('[Widget] Follow-up request failed:', err);
          restoreButton();
        }
      });
    </script>
  </body>
</html>

