<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AlgoTutor</title>
    <script type="oas-config">
      {
        "state": {
          "toolOutput": { "type": "json" }
        }
      }
    </script>
    <style>
      :root {
        color-scheme: light dark;
        --bg-main: #0a0e27;
        --bg-panel: #0f1629;
        --bg-editor: #0a0e27;
        --bg-output: #0a0e27;
        --border-subtle: #1f2937;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.16);
        --accent-strong: rgba(59, 130, 246, 0.9);
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --text-strong: #f9fafb;
        --badge-bg: #1e293b;
        --badge-accent-bg: #1e40af;
        --error: #ef4444;
        --success: #10b981;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro",
          "Inter", sans-serif;
      }

      html,
      body {
        width: 100%;
        min-height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0a0e27 0%, #1e293b 100%);
        padding: 12px;
        color: var(--text-main);
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        border-radius: 16px;
        background: var(--bg-panel);
        border: 1px solid var(--border-subtle);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
        background: linear-gradient(
          to right,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.05)
        );
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-strong);
        background: linear-gradient(to right, #3b82f6, #60a5fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .tagline {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .mode-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 4px;
      }

      .mode-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s;
      }

      .mode-btn:hover {
        border-color: var(--accent);
        color: var(--text-strong);
      }

      .mode-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1.5fr);
        gap: 0;
        min-height: 500px;
      }

      /* Left pane (inputs) */
      .pane-left {
        border-right: 1px solid var(--border-subtle);
        background: var(--bg-editor);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        overflow-y: auto;
      }

      .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-strong);
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
        display: block;
        margin-bottom: 6px;
      }

      .field-block {
        display: flex;
        flex-direction: column;
      }

      textarea,
      select,
      input[type="text"] {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        padding: 10px 12px;
        font-size: 0.85rem;
        box-sizing: border-box;
        background-color: #0a0e27;
        color: var(--text-main);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      textarea:focus,
      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      }

      select {
        font-family: system-ui, sans-serif;
        background-color: #0a0e27;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row > div {
        flex: 1;
      }

      .toggles-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        border-radius: 8px;
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .toggle-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .toggle-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent);
      }

      .toggle-item label {
        margin: 0;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--text-main);
      }

      .hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin: 4px 0 0 0;
      }

      .submit-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border-subtle);
      }

      button.primary {
        border: none;
        border-radius: 8px;
        background: linear-gradient(to right, var(--accent-strong), #60a5fa);
        color: white;
        font-weight: 600;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        transition: all 0.2s;
      }

      button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
      }

      button.primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status {
        font-size: 0.8rem;
        color: var(--text-muted);
        padding: 8px;
        border-radius: 6px;
        background: rgba(15, 23, 42, 0.5);
      }

      /* Right pane (output) */
      .pane-right {
        background: var(--bg-output);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .output-block {
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        background: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.8),
          rgba(15, 23, 42, 0.6)
        );
        padding: 14px;
      }

      .output-block h3 {
        margin: 0 0 10px 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .output-block h3::before {
        content: "‚ñ∏";
        font-size: 1rem;
      }

      .output-content {
        font-size: 0.85rem;
        line-height: 1.6;
        color: var(--text-main);
      }

      .output-empty {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
        text-align: center;
        padding: 40px 20px;
      }

      .code-block {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: #0a0e27;
        color: #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid var(--border-subtle);
        margin-top: 8px;
        overflow-x: auto;
      }

      .table-wrapper {
        overflow-x: auto;
        margin-top: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }

      table th,
      table td {
        padding: 8px;
        text-align: left;
        border: 1px solid var(--border-subtle);
      }

      table th {
        background: rgba(59, 130, 246, 0.2);
        color: var(--text-strong);
        font-weight: 600;
      }

      table td {
        background: rgba(15, 23, 42, 0.5);
      }

      .list-block {
        margin: 8px 0;
        padding-left: 20px;
      }

      .list-block li {
        margin: 6px 0;
        line-height: 1.5;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
        background: var(--badge-accent-bg);
        color: white;
        margin-right: 6px;
      }

      .error-text {
        color: var(--error);
        font-weight: 500;
      }

      .success-text {
        color: var(--success);
        font-weight: 500;
      }

      /* Trick/Shortcut Callout Boxes - Top of output */
      .trick-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 20px;
        position: relative;
      }

      .trick-box::before {
        content: "üí°";
        font-size: 1.5rem;
        position: absolute;
        top: -12px;
        left: 16px;
        background: var(--bg-output);
        padding: 0 8px;
      }

      .trick-box.build {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #3b82f6;
      }

      .trick-box.build::before {
        content: "üéØ";
      }

      .trick-box.debug {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #ef4444;
      }

      .trick-box.debug::before {
        content: "üîç";
      }

      .trick-box-title {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #92400e;
        margin-bottom: 8px;
      }

      .trick-box.build .trick-box-title {
        color: #1e40af;
      }

      .trick-box.debug .trick-box-title {
        color: #991b1b;
      }

      .trick-box-content {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        line-height: 1.5;
      }

      /* Don't Forget / What Profs Test Warning Box */
      .warning-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-left-width: 4px;
        border-radius: 8px;
        padding: 14px 16px;
        margin-top: 16px;
        margin-bottom: 12px;
      }

      .warning-box-title {
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #92400e;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .warning-box-title::before {
        content: "‚ö†Ô∏è";
      }

      .warning-box-content {
        font-size: 0.9rem;
        color: #1f2937;
        line-height: 1.5;
      }

      /* Pattern Signature Keywords */
      .pattern-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .keyword-tag {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      /* Time Estimate Badge */
      .time-estimate {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        margin: 8px 0;
      }

      .time-estimate::before {
        content: "‚è±Ô∏è";
      }

      /* Exact Bug Line Highlight */
      .bug-line-box {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
      }

      .bug-line-number {
        font-weight: 700;
        color: #ef4444;
        font-size: 0.9rem;
      }

      .bug-line-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        background: #1f2937;
        color: #fca5a5;
        padding: 8px 12px;
        border-radius: 6px;
        margin: 8px 0;
        font-size: 0.85rem;
        overflow-x: auto;
      }

      .bug-line-issue {
        font-size: 0.85rem;
        color: var(--text-main);
      }

      /* Fill-in-Blank Answers */
      .blank-answer {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
      }

      .blank-answer-label {
        font-weight: 600;
        color: #10b981;
        font-size: 0.85rem;
        margin-bottom: 4px;
      }

      .blank-answer-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        background: #1f2937;
        color: #6ee7b7;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
        display: inline-block;
        margin: 4px 0;
      }

      .blank-answer-reason {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 6px;
        font-style: italic;
      }

      /* If On Exam Box */
      .exam-tip-box {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        padding: 12px 14px;
        margin-top: 12px;
      }

      .exam-tip-title {
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #8b5cf6;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .exam-tip-title::before {
        content: "üìù";
      }

      .exam-tip-content {
        font-size: 0.85rem;
        color: var(--text-main);
        line-height: 1.5;
      }

      /* Upgrade button styles */
      .upgrade-container {
        text-align: center;
        padding: 40px 20px;
      }

      .upgrade-message {
        font-size: 1.1rem;
        color: var(--error);
        margin-bottom: 20px;
      }

      .upgrade-btn {
        display: inline-block;
        padding: 14px 28px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
      }

      .upgrade-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
      }

      /* Premium activation button in header */
      .activate-premium-btn {
        padding: 8px 14px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .activate-premium-btn:hover {
        transform: scale(1.05);
      }

      /* Header buttons container */
      .header-buttons {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* Help link */
      .help-link {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 0.75rem;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }

      .help-link:hover {
        color: var(--accent);
        background: rgba(59, 130, 246, 0.1);
      }

      /* Cancel subscription button */
      .cancel-subscription-btn {
        padding: 6px 10px;
        background: transparent;
        color: var(--text-muted);
        font-size: 0.75rem;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: none;
      }

      .cancel-subscription-btn:hover {
        color: var(--error);
        border-color: var(--error);
      }

      /* Modal styles */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg-panel);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }

      .modal h2 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--text-strong);
      }

      .modal p {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .modal-input {
        width: 100%;
        padding: 12px;
        background: var(--bg-editor);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-main);
        font-size: 1.1rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-align: center;
        margin-bottom: 1rem;
      }

      .modal-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
      }

      .modal-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .modal-btn-primary:hover {
        transform: translateY(-1px);
      }

      .modal-btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .modal-btn-secondary {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
      }

      .modal-btn-secondary:hover {
        border-color: var(--text-muted);
      }

      .modal-message {
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: center;
      }

      .modal-message.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid var(--success);
      }

      .modal-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
        border: 1px solid var(--error);
      }

      /* Mode-specific visibility */
      .mode-content {
        display: none;
      }

      .mode-content.active {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* Premium success state */
      .premium-success-container {
        text-align: center;
        padding: 60px 20px;
      }

      .premium-success-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      .premium-success-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--success);
        margin-bottom: 12px;
      }

      .premium-success-message {
        font-size: 1rem;
        color: var(--text-main);
        margin-bottom: 8px;
        line-height: 1.6;
      }

      .premium-success-hint {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 20px;
        padding: 12px 16px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <main>
      <header>
        <div class="header-top">
          <div>
            <h1>üöÄ AlgoTutor</h1>
            <p class="tagline">
              Exam Cheat Code Edition: Pattern recognition, paper-friendly code,
              and the tricks professors test
            </p>
          </div>
          <div class="header-buttons">
            <button class="help-link" id="help-btn" title="Contact support">
              Need Help?
            </button>
            <button class="cancel-subscription-btn" id="cancel-subscription-btn">
              Cancel Subscription
            </button>
            <button class="activate-premium-btn" id="activate-premium-btn">
              ‚ö° Activate Premium
            </button>
          </div>
        </div>
        <div class="mode-selector">
          <button class="mode-btn active" data-mode="learn">
            üìö Learn Mode
          </button>
          <button class="mode-btn" data-mode="build">üî® Build Mode</button>
          <button class="mode-btn" data-mode="debug">üêõ Debug Mode</button>
        </div>
      </header>

      <div class="layout">
        <!-- LEFT PANE: Inputs -->
        <section class="pane-left">
          <!-- LEARN MODE -->
          <form id="learn-form" class="mode-content active">
            <h2 class="section-title">Learn Mode</h2>

            <div class="field-block">
              <label for="learn-topic">Pattern / Topic</label>
              <input
                type="text"
                id="learn-topic"
                placeholder="e.g., BFS, two pointers, sliding window, DFS, merge sort"
              />
            </div>

            <div class="row">
              <div class="field-block">
                <label for="learn-difficulty">Difficulty</label>
                <select id="learn-difficulty">
                  <option value="basic">Basic</option>
                  <option value="normal" selected>Normal</option>
                  <option value="dumb-it-down">Dumb-It-Down</option>
                </select>
              </div>
              <div class="field-block">
                <label for="learn-depth">Depth</label>
                <select id="learn-depth">
                  <option value="tiny">Tiny (5 steps)</option>
                  <option value="normal" selected>Normal</option>
                  <option value="full">Full Walkthrough</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field-block">
                <label for="learn-example-size">Example Size</label>
                <select id="learn-example-size">
                  <option value="small" selected>Small</option>
                  <option value="medium">Medium</option>
                </select>
              </div>
            </div>

            <div class="toggles-section">
              <div class="toggle-item">
                <input type="checkbox" id="learn-pattern-keywords" checked />
                <label for="learn-pattern-keywords">Show pattern keywords</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="learn-dry-run" checked />
                <label for="learn-dry-run">Show trace table (exam format)</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="learn-paper-version" checked />
                <label for="learn-paper-version">Show paper summary</label>
              </div>
            </div>

            <div class="submit-section">
              <button type="submit" class="primary">
                <span>üìö</span>
                <span>Learn This Topic</span>
              </button>
              <div class="status" id="learn-status">
                Ready. Enter a topic to learn.
              </div>
            </div>
          </form>

          <!-- BUILD MODE -->
          <form id="build-form" class="mode-content">
            <h2 class="section-title">Build Mode</h2>

            <div class="field-block">
              <label for="build-problem">Problem Description</label>
              <textarea
                id="build-problem"
                placeholder="Paste your coding problem here..."
              ></textarea>
            </div>

            <div class="field-block">
              <label for="build-testcases">Test Cases (optional)</label>
              <textarea
                id="build-testcases"
                placeholder="Enter test cases the solution should pass..."
                style="min-height: 80px;"
              ></textarea>
              <p class="hint">
                Provide example inputs/outputs to verify the solution.
              </p>
            </div>

            <div class="row">
              <div class="field-block">
                <label for="build-language">Language</label>
                <select id="build-language">
                  <option value="python" selected>Python</option>
                  <option value="java">Java</option>
                  <option value="cpp">C++</option>
                </select>
              </div>
            </div>

            <div class="toggles-section">
              <div class="toggle-item">
                <input type="checkbox" id="build-recursion" />
                <label for="build-recursion">Allow recursion</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="build-skeleton" />
                <label for="build-skeleton">Skeleton only (no implementation)</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="build-dry-run" checked />
                <label for="build-dry-run">Include dry-run (exam format)</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="build-minimal-code" checked />
                <label for="build-minimal-code">Minimal code style</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="build-time-estimate" checked />
                <label for="build-time-estimate">Show time estimate</label>
              </div>
            </div>

            <div class="submit-section">
              <button type="submit" class="primary">
                <span>üî®</span>
                <span>Build Solution</span>
              </button>
              <div class="status" id="build-status">
                Ready. Enter a problem to solve.
              </div>
            </div>
          </form>

          <!-- DEBUG MODE -->
          <form id="debug-form" class="mode-content">
            <h2 class="section-title">Debug Mode</h2>

            <div class="field-block">
              <label for="debug-mode-select">Mode</label>
              <select id="debug-mode-select">
                <option value="debug" selected>Debug existing code</option>
                <option value="fill-in-blank">Fill-in-the-blank exercise</option>
              </select>
              <p class="hint" id="debug-mode-hint">
                Debug: Find and fix bugs in your code.
              </p>
            </div>

            <div class="field-block">
              <label for="debug-code">Code Snippet</label>
              <textarea
                id="debug-code"
                placeholder="Paste your code here... For fill-in-blank, use ___ or # TODO for blanks"
              ></textarea>
            </div>

            <div class="field-block">
              <label for="debug-problem">Problem Description (optional)</label>
              <textarea
                id="debug-problem"
                placeholder="Describe what this code should do..."
                style="min-height: 80px;"
              ></textarea>
              <p class="hint">
                Helps AlgoTutor understand the algorithm context.
              </p>
            </div>

            <div class="row">
              <div class="field-block">
                <label for="debug-language">Language</label>
                <select id="debug-language">
                  <option value="python" selected>Python</option>
                  <option value="java">Java</option>
                  <option value="cpp">C++</option>
                </select>
              </div>
            </div>

            <div class="toggles-section">
              <div class="toggle-item">
                <input type="checkbox" id="debug-show-tests" checked />
                <label for="debug-show-tests">Generate test cases</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="debug-edge-warnings" checked />
                <label for="debug-edge-warnings">Show edge case warnings</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="debug-trace-table" checked />
                <label for="debug-trace-table">Show trace table (exam format)</label>
              </div>
              <div class="toggle-item">
                <input type="checkbox" id="debug-pattern-explanation" checked />
                <label for="debug-pattern-explanation">Explain algorithm pattern</label>
              </div>
            </div>

            <div class="submit-section">
              <button type="submit" class="primary">
                <span>üêõ</span>
                <span>Debug This Code</span>
              </button>
              <div class="status" id="debug-status">
                Ready. Paste your code to debug.
              </div>
            </div>
          </form>
        </section>

        <!-- RIGHT PANE: Outputs -->
        <section class="pane-right" id="output-container">
          <div class="output-empty">
            Select a mode on the left, fill in the details, and submit.<br />
            All explanations will appear here in structured blocks.
          </div>
        </section>
      </div>
    </main>

    <!-- Premium Activation Modal -->
    <div class="modal-overlay" id="premium-modal">
      <div class="modal">
        <h2>‚ö° Activate Premium</h2>
        <p>Enter the activation code from your purchase confirmation.</p>
        <div id="modal-message" class="modal-message" style="display: none;"></div>
        <input 
          type="text" 
          class="modal-input" 
          id="premium-code-input" 
          placeholder="ALGO-XXXXXX"
          maxlength="11"
        />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>
          <button class="modal-btn modal-btn-primary" id="modal-activate">Activate</button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
      <div class="modal">
        <h2>Need Help?</h2>
        <p>Have questions, concerns, or running into issues? We're here to help!</p>
        <div style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 8px; margin: 16px 0;">
          <p style="margin: 0; color: var(--text-main);">
            Contact us at:<br>
            <a href="mailto:support@algo-tutor.org" style="color: var(--accent); font-weight: 600; font-size: 1.1rem;">
              support@algo-tutor.org
            </a>
          </p>
        </div>
        <p style="font-size: 0.85rem; color: var(--text-muted);">
          We typically respond within 24 hours.
        </p>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="help-modal-close">Close</button>
          <a href="mailto:support@algo-tutor.org" class="modal-btn modal-btn-primary" style="text-decoration: none; text-align: center;">
            Send Email
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      // DEBUGGING: Log everything available on window
      console.log("============================================");
      console.log("[Widget] INITIAL LOAD - Checking window object");
      console.log("[Widget] window.openai:", window.openai);
      console.log("[Widget] window.state:", window.state);
      console.log("[Widget] Full window keys:", Object.keys(window).filter(k => k.includes('openai') || k.includes('state') || k.includes('widget')));
      console.log("============================================");

      // State management
      let currentMode = "learn";
      let currentState = {
        mode: null,
        outputs: null,
      };

      // DOM Elements
      const modeBtns = document.querySelectorAll(".mode-btn");
      const modeForms = {
        learn: document.querySelector("#learn-form"),
        build: document.querySelector("#build-form"),
        debug: document.querySelector("#debug-form"),
      };
      const outputContainer = document.querySelector("#output-container");

      // Helper: Get state from ChatGPT - with extensive logging
      const getInitialState = () => {
        console.log("[Widget] getInitialState() called");
        
        // Check all possible locations
        console.log("[Widget] Checking window.openai:", window.openai);
        console.log("[Widget] Checking window.openai?.globals:", window.openai?.globals);
        console.log("[Widget] Checking window.openai?.state:", window.openai?.state);
        console.log("[Widget] Checking window.openai?.widgetState:", window.openai?.widgetState);
        console.log("[Widget] Checking window.openai?.initialState:", window.openai?.initialState);
        
        const w = window.openai || {};
        
        // Try all possible paths
        if (w.globals?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.globals.toolOutput");
          return w.globals.toolOutput;
        }
        if (w.state?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.state.toolOutput");
          return w.state.toolOutput;
        }
        if (w.widgetState?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.widgetState.toolOutput");
          return w.widgetState.toolOutput;
        }
        if (w.initialState?.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.initialState.toolOutput");
          return w.initialState.toolOutput;
        }
        if (w.toolOutput) {
          console.log("[Widget] ‚úÖ Found state in window.openai.toolOutput");
          return w.toolOutput;
        }
        
        console.warn("[Widget] ‚ùå No initial state found anywhere");
        return { mode: null, outputs: null };
      };

      currentState = getInitialState();
      console.log("[Widget] Initial currentState:", JSON.stringify(currentState, null, 2));

      // Mode switching
      modeBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          currentMode = mode;

          // Update button states
          modeBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // Update form visibility
          Object.values(modeForms).forEach((form) =>
            form.classList.remove("active")
          );
          modeForms[mode].classList.add("active");
        });
      });

      // Send follow-up message to ChatGPT
      const sendFollowUp = async (prompt) => {
        if (window.openai?.sendFollowUpMessage) {
          return await window.openai.sendFollowUpMessage({ prompt });
        }
        throw new Error("OpenAI sendFollowUpMessage API not available");
      };

      // Render outputs - Exam Cheat Code Edition
      const renderOutputs = (outputs) => {
        console.log("[Widget] ==================== renderOutputs CALLED ====================");
        console.log("[Widget] Outputs received:", JSON.stringify(outputs, null, 2));
        console.log("[Widget] Outputs type:", typeof outputs);
        console.log("[Widget] Outputs keys:", outputs ? Object.keys(outputs) : "null");
        
        outputContainer.innerHTML = "";

        if (!outputs) {
          console.warn("[Widget] No outputs provided - showing empty state");
          outputContainer.innerHTML =
            '<div class="output-empty">No outputs yet. Submit a query to see results.</div>';
          return;
        }

        // Check if outputs is an empty object
        if (typeof outputs === 'object' && Object.keys(outputs).length === 0) {
          console.warn("[Widget] Outputs is an empty object");
          outputContainer.innerHTML =
            '<div class="output-empty">‚ö†Ô∏è Received empty outputs. Please try again.</div>';
          return;
        }

        // Check if ALL fields are empty/null
        const hasContent = Object.values(outputs).some(val => {
          if (val === null || val === undefined) return false;
          if (typeof val === 'string') return val.trim().length > 0;
          if (Array.isArray(val)) return val.length > 0;
          if (typeof val === 'object') return Object.keys(val).length > 0;
          return true;
        });

        if (!hasContent) {
          console.warn("[Widget] All output fields are empty:", outputs);
          outputContainer.innerHTML =
            '<div class="output-empty">‚ö†Ô∏è ChatGPT did not generate content. Please try again.<br><small style="color: #9ca3af; margin-top: 8px; display: block;">Tip: Make sure to describe what you want clearly.</small></div>';
          return;
        }

        console.log("[Widget] ‚úÖ Outputs has content, proceeding to render blocks");
        
        // Determine mode based on outputs
        const isDebugMode = outputs.exactBugLine || outputs.fillInBlankAnswers || outputs.beforeCode;
        const isBuildMode = outputs.theShortcut || outputs.dontForget || outputs.timeEstimate;
        const isLearnMode = outputs.patternSignature || outputs.memorableTemplate || outputs.whatProfessorsTest;

        // === RENDER TRICK BOX FIRST (TOP OF OUTPUT) ===
        if (outputs.theTrick) {
          const trickClass = isDebugMode ? 'debug' : (isBuildMode ? 'build' : '');
          const trickTitle = isDebugMode ? 'THE TRICK' : (isBuildMode ? 'THE SHORTCUT' : 'THE TRICK');
          const trickEl = document.createElement('div');
          trickEl.className = `trick-box ${trickClass}`;
          trickEl.innerHTML = `
            <div class="trick-box-title">${trickTitle}</div>
            <div class="trick-box-content">${escapeHtml(outputs.theTrick)}</div>
          `;
          outputContainer.appendChild(trickEl);
        }
        
        // Build Mode: The Shortcut
        if (outputs.theShortcut && !outputs.theTrick) {
          const trickEl = document.createElement('div');
          trickEl.className = 'trick-box build';
          trickEl.innerHTML = `
            <div class="trick-box-title">THE SHORTCUT</div>
            <div class="trick-box-content">${escapeHtml(outputs.theShortcut)}</div>
          `;
          outputContainer.appendChild(trickEl);
        }

        // === MAIN CONTENT BLOCKS ===
        const blocks = [];

        // What Code Does (Debug/Trace mode)
        if (outputs.whatCodeDoes) {
          blocks.push({
            title: "What This Code Does",
            content: outputs.whatCodeDoes,
            type: "text",
          });
        }

        // Pattern Detection
        if (outputs.pattern) {
          blocks.push({
            title: "Pattern Detection",
            content: outputs.pattern,
            type: "text",
          });
        }

        // Pattern Signature Keywords (Learn/Pattern Recognition mode)
        if (outputs.patternSignature && Array.isArray(outputs.patternSignature)) {
          blocks.push({
            title: "Pattern Signature",
            content: outputs.patternSignature,
            type: "keywords",
          });
        }

        // Step-by-step reasoning
        if (outputs.stepByStep) {
          blocks.push({
            title: "Step-by-Step",
            content: outputs.stepByStep,
            type: "text",
          });
        }

        // Memorable Template (Learn mode)
        if (outputs.memorableTemplate) {
          blocks.push({
            title: "5-Line Memorizable Template",
            content: outputs.memorableTemplate,
            type: "code",
          });
        }

        // Code Solution
        if (outputs.code) {
          blocks.push({
            title: "Code Solution",
            content: outputs.code,
            type: "code",
          });
        }

        // Time Estimate (Build mode)
        if (outputs.timeEstimate) {
          blocks.push({
            title: null, // No title - rendered as inline badge
            content: outputs.timeEstimate,
            type: "timeEstimate",
          });
        }

        // Example Walkthrough (Learn mode)
        if (outputs.exampleWalkthrough) {
          blocks.push({
            title: "Example Walkthrough",
            content: outputs.exampleWalkthrough,
            type: "text",
          });
        }

        // Exact Bug Line (Debug mode)
        if (outputs.exactBugLine) {
          blocks.push({
            title: "Exact Bug Location",
            content: outputs.exactBugLine,
            type: "bugLine",
          });
        }

        // Trace Table / Dry-run table (exam format)
        if (outputs.traceTable && Array.isArray(outputs.traceTable)) {
          blocks.push({
            title: "Trace Table (Exam Format)",
            content: outputs.traceTable,
            type: "table",
          });
        } else if (outputs.dryRunTable && Array.isArray(outputs.dryRunTable)) {
          blocks.push({
            title: "Trace Table (Exam Format)",
            content: outputs.dryRunTable,
            type: "table",
          });
        }

        // Fill-in-Blank Answers (Debug mode)
        if (outputs.fillInBlankAnswers && Array.isArray(outputs.fillInBlankAnswers)) {
          blocks.push({
            title: "Fill-in-the-Blank Answers",
            content: outputs.fillInBlankAnswers,
            type: "fillInBlank",
          });
        }

        // Bug Diagnosis (Debug mode)
        if (outputs.bugDiagnosis) {
          blocks.push({
            title: "Bug Diagnosis",
            content: outputs.bugDiagnosis,
            type: "text",
          });
        }

        // Before/After code (Debug mode)
        if (outputs.beforeCode || outputs.afterCode) {
          blocks.push({
            title: "Before & After Fix",
            content: `<div><strong>Before:</strong><pre class="code-block">${escapeHtml(
              outputs.beforeCode || "N/A"
            )}</pre></div><div style="margin-top: 12px;"><strong>After:</strong><pre class="code-block">${escapeHtml(
              outputs.afterCode || "N/A"
            )}</pre></div>`,
            type: "html",
          });
        }

        // Complexity analysis
        if (outputs.complexity) {
          blocks.push({
            title: "Time & Space Complexity",
            content: outputs.complexity,
            type: "text",
          });
        }

        // Render main blocks
        blocks.forEach((block, idx) => {
          if (block.type === "timeEstimate") {
            // Render as inline badge
            const badgeEl = document.createElement("div");
            badgeEl.className = "time-estimate";
            badgeEl.textContent = block.content;
            outputContainer.appendChild(badgeEl);
            return;
          }

          if (block.type === "keywords") {
            // Render as keyword tags
            const blockEl = document.createElement("div");
            blockEl.className = "output-block";
            blockEl.innerHTML = `<h3>${block.title}</h3>`;
            const keywordsDiv = document.createElement("div");
            keywordsDiv.className = "pattern-keywords";
            block.content.forEach(keyword => {
              const tag = document.createElement("span");
              tag.className = "keyword-tag";
              tag.textContent = keyword;
              keywordsDiv.appendChild(tag);
            });
            blockEl.appendChild(keywordsDiv);
            outputContainer.appendChild(blockEl);
            return;
          }

          if (block.type === "bugLine") {
            // Render bug line highlight
            const blockEl = document.createElement("div");
            blockEl.className = "output-block";
            blockEl.innerHTML = `<h3>${block.title}</h3>`;
            const bugBox = document.createElement("div");
            bugBox.className = "bug-line-box";
            const line = block.content;
            bugBox.innerHTML = `
              <div class="bug-line-number">Line ${line.lineNumber || '?'}</div>
              <div class="bug-line-code">${escapeHtml(line.code || '')}</div>
              <div class="bug-line-issue">${escapeHtml(line.issue || '')}</div>
            `;
            blockEl.appendChild(bugBox);
            outputContainer.appendChild(blockEl);
            return;
          }

          if (block.type === "fillInBlank") {
            // Render fill-in-blank answers
            const blockEl = document.createElement("div");
            blockEl.className = "output-block";
            blockEl.innerHTML = `<h3>${block.title}</h3>`;
            block.content.forEach(item => {
              const answerDiv = document.createElement("div");
              answerDiv.className = "blank-answer";
              answerDiv.innerHTML = `
                <div class="blank-answer-label">${escapeHtml(item.blank || 'Blank')}</div>
                <div class="blank-answer-code">${escapeHtml(item.answer || '')}</div>
                <div class="blank-answer-reason">${escapeHtml(item.reason || '')}</div>
              `;
              blockEl.appendChild(answerDiv);
            });
            outputContainer.appendChild(blockEl);
            return;
          }

          // Standard block rendering
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";

          const titleEl = document.createElement("h3");
          titleEl.textContent = block.title;
          blockEl.appendChild(titleEl);

          const contentEl = document.createElement("div");
          contentEl.className = "output-content";

          if (block.type === "code") {
            contentEl.innerHTML = `<pre class="code-block">${escapeHtml(block.content)}</pre>`;
          } else if (block.type === "table" && Array.isArray(block.content)) {
            const table = renderTable(block.content);
            if (table) contentEl.appendChild(table);
          } else if (block.type === "list" && Array.isArray(block.content)) {
            const ul = document.createElement("ul");
            ul.className = "list-block";
            block.content.forEach((item) => {
              const li = document.createElement("li");
              li.textContent = typeof item === 'string' ? item : JSON.stringify(item);
              ul.appendChild(li);
            });
            contentEl.appendChild(ul);
          } else if (block.type === "html") {
            contentEl.innerHTML = block.content;
          } else {
            contentEl.innerHTML = String(block.content).replace(/\n/g, "<br>");
          }

          blockEl.appendChild(contentEl);
          outputContainer.appendChild(blockEl);
        });

        // === WARNING BOXES (near bottom) ===
        
        // Don't Forget (Build mode)
        if (outputs.dontForget) {
          const warningEl = document.createElement("div");
          warningEl.className = "warning-box";
          warningEl.innerHTML = `
            <div class="warning-box-title">DON'T FORGET</div>
            <div class="warning-box-content">${escapeHtml(outputs.dontForget)}</div>
          `;
          outputContainer.appendChild(warningEl);
        }

        // What Professors Test (Learn mode)
        if (outputs.whatProfessorsTest) {
          const warningEl = document.createElement("div");
          warningEl.className = "warning-box";
          warningEl.innerHTML = `
            <div class="warning-box-title">WHAT PROFESSORS TEST</div>
            <div class="warning-box-content">${escapeHtml(outputs.whatProfessorsTest)}</div>
          `;
          outputContainer.appendChild(warningEl);
        }

        // If On Exam (Debug mode)
        if (outputs.ifOnExam) {
          const examTipEl = document.createElement("div");
          examTipEl.className = "exam-tip-box";
          examTipEl.innerHTML = `
            <div class="exam-tip-title">IF THIS APPEARS ON EXAM</div>
            <div class="exam-tip-content">${escapeHtml(outputs.ifOnExam)}</div>
          `;
          outputContainer.appendChild(examTipEl);
        }

        // === BOTTOM SECTION ===

        // Paper Version / Paper Summary (both modes)
        if (outputs.paperVersion && Array.isArray(outputs.paperVersion)) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Paper Version</h3>`;
          const ul = document.createElement("ul");
          ul.className = "list-block";
          outputs.paperVersion.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          blockEl.appendChild(ul);
          outputContainer.appendChild(blockEl);
        }

        if (outputs.paperSummary && Array.isArray(outputs.paperSummary)) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Paper Summary (Exam Day)</h3>`;
          const ul = document.createElement("ul");
          ul.className = "list-block";
          outputs.paperSummary.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          blockEl.appendChild(ul);
          outputContainer.appendChild(blockEl);
        }

        // Test Cases
        if (outputs.testCases && Array.isArray(outputs.testCases)) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Test Cases</h3>`;
          const ul = document.createElement("ul");
          ul.className = "list-block";
          outputs.testCases.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          blockEl.appendChild(ul);
          outputContainer.appendChild(blockEl);
        }

        // Edge Cases (legacy support)
        if (outputs.edgeCases && Array.isArray(outputs.edgeCases)) {
          const blockEl = document.createElement("div");
          blockEl.className = "output-block";
          blockEl.innerHTML = `<h3>Edge Cases</h3>`;
          const ul = document.createElement("ul");
          ul.className = "list-block";
          outputs.edgeCases.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          blockEl.appendChild(ul);
          outputContainer.appendChild(blockEl);
        }
        
        console.log("[Widget] ‚úÖ‚úÖ‚úÖ RENDERING COMPLETE - All blocks added to DOM");
        console.log("[Widget] outputContainer has", outputContainer.children.length, "children");
      };

      const renderTable = (rows) => {
        if (!rows || rows.length === 0) return null;

        const wrapper = document.createElement("div");
        wrapper.className = "table-wrapper";

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        // Header
        const headerRow = document.createElement("tr");
        Object.keys(rows[0]).forEach((key) => {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Rows
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          Object.values(row).forEach((val) => {
            const td = document.createElement("td");
            td.textContent = val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        wrapper.appendChild(table);
        return wrapper;
      };

      const escapeHtml = (str) =>
        String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      // Form submissions
      modeForms.learn.addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusEl = document.querySelector("#learn-status");

        const topic = document.querySelector("#learn-topic").value.trim();
        const difficulty = document.querySelector("#learn-difficulty").value;
        const depth = document.querySelector("#learn-depth").value;
        const exampleSize = document.querySelector("#learn-example-size").value;
        const showPatternKeywords = document.querySelector("#learn-pattern-keywords").checked;
        const showDryRun = document.querySelector("#learn-dry-run").checked;
        const showPaperVersion = document.querySelector("#learn-paper-version").checked;

        if (!topic) {
          statusEl.textContent = "Please enter a pattern/topic.";
          return;
        }

        statusEl.textContent = "Generating lesson...";
        
        // Build natural language prompt for ChatGPT - Learn Mode
        let prompt = `Use AlgoTutor Learn Mode to teach me ${topic} with ${difficulty} difficulty and ${depth} depth.`;
        prompt += ` Use ${exampleSize} example size.`;
        if (showPatternKeywords) prompt += ` Show pattern signature keywords.`;
        if (showDryRun) prompt += ` Include exam-format trace table.`;
        if (showPaperVersion) prompt += ` Include paper summary.`;

        try {
          await sendFollowUp(prompt);
          statusEl.textContent = "‚úÖ Request sent!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      });

      modeForms.build.addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusEl = document.querySelector("#build-status");

        const problem = document.querySelector("#build-problem").value.trim();
        const testCases = document.querySelector("#build-testcases").value.trim();
        const language = document.querySelector("#build-language").value;
        const allowRecursion = document.querySelector("#build-recursion").checked;
        const skeletonOnly = document.querySelector("#build-skeleton").checked;
        const includeDryRun = document.querySelector("#build-dry-run").checked;
        const minimalCode = document.querySelector("#build-minimal-code").checked;
        const showTimeEstimate = document.querySelector("#build-time-estimate").checked;

        if (!problem) {
          statusEl.textContent = "Please enter a problem.";
          return;
        }

        statusEl.textContent = "Building solution...";
        
        // Build natural language prompt for ChatGPT - Build Mode
        let prompt = `Use AlgoTutor Build Mode to solve this problem in ${language}: ${problem}.`;
        if (testCases) prompt += ` The solution must pass these test cases: ${testCases}.`;
        if (minimalCode) prompt += ` Use minimal paper-friendly code.`;
        if (allowRecursion) prompt += ` Recursion is allowed.`;
        if (skeletonOnly) prompt += ` Show skeleton only.`;
        if (includeDryRun) prompt += ` Include exam-format dry-run.`;
        if (showTimeEstimate) prompt += ` Show time estimate.`;

        try {
          await sendFollowUp(prompt);
          statusEl.textContent = "‚úÖ Request sent!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      });

      modeForms.debug.addEventListener("submit", async (e) => {
        e.preventDefault();
        const statusEl = document.querySelector("#debug-status");

        const code = document.querySelector("#debug-code").value.trim();
        const problemDescription = document.querySelector("#debug-problem").value.trim();
        const language = document.querySelector("#debug-language").value;
        const debugMode = document.querySelector("#debug-mode-select").value;
        const generateTests = document.querySelector("#debug-show-tests").checked;
        const showEdgeWarnings = document.querySelector("#debug-edge-warnings").checked;
        const showTraceTable = document.querySelector("#debug-trace-table").checked;
        const showPatternExplanation = document.querySelector("#debug-pattern-explanation").checked;

        if (!code) {
          statusEl.textContent = "Please paste your code.";
          return;
        }

        const isFillInBlank = debugMode === 'fill-in-blank';
        statusEl.textContent = isFillInBlank ? "Filling in blanks..." : "Debugging code...";
        
        // Build natural language prompt for ChatGPT - Debug Mode
        let prompt;
        if (isFillInBlank) {
          prompt = `Use AlgoTutor Debug Mode in fill-in-the-blank mode for this ${language} code`;
        } else {
          prompt = `Use AlgoTutor Debug Mode to debug this ${language} code`;
        }
        if (problemDescription) {
          prompt += ` for the following problem: ${problemDescription}`;
        }
        prompt += `.\n\nCode:\n\`\`\`${language}\n${code}\n\`\`\``;
        if (generateTests) prompt += `\nGenerate test cases.`;
        if (showEdgeWarnings) prompt += ` Show edge case warnings.`;
        if (showTraceTable) prompt += ` Show exam-format trace table.`;
        if (showPatternExplanation) prompt += ` Explain the algorithm pattern.`;

        try {
          await sendFollowUp(prompt);
          statusEl.textContent = "‚úÖ Request sent!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      });

      // Debug mode selector hint update
      const debugModeSelect = document.querySelector("#debug-mode-select");
      const debugModeHint = document.querySelector("#debug-mode-hint");
      if (debugModeSelect && debugModeHint) {
        debugModeSelect.addEventListener("change", (e) => {
          if (e.target.value === "fill-in-blank") {
            debugModeHint.textContent = "Fill-in-blank: Use ___ or # TODO for blanks in your code.";
          } else {
            debugModeHint.textContent = "Debug: Find and fix bugs in your code.";
          }
        });
      }

      // Helper: Try to extract outputs from various formats
      function extractOutputs(data) {
        console.log("[Widget] extractOutputs called with:", typeof data, data);
        
        // If data is a string, try to parse it as JSON
        if (typeof data === 'string') {
          try {
            data = JSON.parse(data);
            console.log("[Widget] Parsed JSON string:", data);
          } catch (e) {
            console.log("[Widget] Not valid JSON string");
            return null;
          }
        }
        
        if (!data) return null;
        
        // Direct outputs object
        if (data.outputs) {
          console.log("[Widget] Found outputs directly");
          return data.outputs;
        }
        
        // If data itself looks like outputs (has pattern, stepByStep, etc.)
        if (data.pattern || data.stepByStep || data.code) {
          console.log("[Widget] Data looks like outputs itself");
          return data;
        }
        
        // toolOutput wrapper
        if (data.toolOutput?.outputs) {
          console.log("[Widget] Found outputs in toolOutput");
          return data.toolOutput.outputs;
        }
        
        // result wrapper
        if (data.result?.outputs) {
          console.log("[Widget] Found outputs in result");
          return data.result.outputs;
        }
        
        // Nested result.toolOutput
        if (data.result?.toolOutput?.outputs) {
          console.log("[Widget] Found outputs in result.toolOutput");
          return data.result.toolOutput.outputs;
        }
        
        return null;
      }

      // Helper: Check for errors with upgrade URL
      function extractError(data) {
        console.log("[Widget] extractError called with:", typeof data, data);
        
        if (typeof data === 'string') {
          try {
            data = JSON.parse(data);
            console.log("[Widget] extractError: parsed JSON string to:", data);
          } catch (e) {
            console.log("[Widget] extractError: not valid JSON string");
            return null;
          }
        }
        
        if (!data) return null;
        
        // Check direct error (new format: error is at root level of parsed JSON)
        if (data.error) {
          console.log("[Widget] ‚úÖ extractError: found error at data.error:", data.error);
          return data.error;
        }
        
        // Check toolOutput.error
        if (data.toolOutput?.error) {
          console.log("[Widget] ‚úÖ extractError: found error at data.toolOutput.error:", data.toolOutput.error);
          return data.toolOutput.error;
        }
        
        // Check result.error
        if (data.result?.error) {
          console.log("[Widget] ‚úÖ extractError: found error at data.result.error:", data.result.error);
          return data.result.error;
        }
        
        // Check toolOutput.text (might contain JSON with error)
        if (data.toolOutput?.text) {
          console.log("[Widget] extractError: checking data.toolOutput.text");
          return extractError(data.toolOutput.text);
        }
        
        // Check content[0].text (MCP format)
        if (data.content?.[0]?.text) {
          console.log("[Widget] extractError: checking data.content[0].text");
          return extractError(data.content[0].text);
        }
        
        console.log("[Widget] extractError: no error found");
        return null;
      }

      // Helper: Format remaining time for countdown
      function formatCountdown(expiresAt) {
        const now = Date.now();
        const expires = new Date(expiresAt).getTime();
        const remaining = expires - now;
        
        if (remaining <= 0) return null; // Expired
        
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        
        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        }
        return `${minutes}m`;
      }

      // Render error with upgrade button
      function renderError(error) {
        console.log("[Widget] ==================== renderError ====================");
        console.log("[Widget] Rendering error:", JSON.stringify(error, null, 2));
        outputContainer.innerHTML = '';
        
        // Store cooldown expiry in localStorage if present
        if (error.cooldownExpiresAt) {
          localStorage.setItem('algotutor_cooldown_expires', error.cooldownExpiresAt);
          console.log("[Widget] Stored cooldown expires at:", error.cooldownExpiresAt);
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'upgrade-container';
        
        // Error icon
        const iconDiv = document.createElement('div');
        iconDiv.style.fontSize = '3rem';
        iconDiv.style.marginBottom = '16px';
        iconDiv.textContent = '‚ö†Ô∏è';
        errorDiv.appendChild(iconDiv);
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'upgrade-message';
        messageDiv.textContent = error.message || 'An error occurred.';
        errorDiv.appendChild(messageDiv);
        
        // Show countdown timer if cooldown is active
        if (error.cooldownExpiresAt) {
          const countdownDiv = document.createElement('div');
          countdownDiv.id = 'cooldown-timer';
          countdownDiv.style.marginTop = '12px';
          countdownDiv.style.padding = '8px 16px';
          countdownDiv.style.background = 'rgba(59, 130, 246, 0.1)';
          countdownDiv.style.borderRadius = '8px';
          countdownDiv.style.color = 'var(--accent)';
          countdownDiv.style.fontSize = '0.9rem';
          countdownDiv.style.fontWeight = '500';
          
          const updateCountdown = () => {
            const formatted = formatCountdown(error.cooldownExpiresAt);
            if (formatted) {
              countdownDiv.textContent = `‚è±Ô∏è Try again in ${formatted}`;
            } else {
              countdownDiv.textContent = '‚úÖ You can try again now!';
              countdownDiv.style.background = 'rgba(16, 185, 129, 0.1)';
              countdownDiv.style.color = '#10b981';
              localStorage.removeItem('algotutor_cooldown_expires');
            }
          };
          
          updateCountdown();
          // Update every minute
          const intervalId = setInterval(updateCountdown, 60000);
          // Store interval ID so we can clear it later
          countdownDiv.dataset.intervalId = intervalId;
          
          errorDiv.appendChild(countdownDiv);
        }
        
        if (error.upgradeUrl) {
          console.log("[Widget] ‚úÖ upgradeUrl found, creating button:", error.upgradeUrl);
          
          // Add some spacing
          const spacer = document.createElement('div');
          spacer.style.marginBottom = '20px';
          errorDiv.appendChild(spacer);
          
          const upgradeBtn = document.createElement('button');
          upgradeBtn.className = 'upgrade-btn';
          upgradeBtn.textContent = '‚ö° Upgrade to Premium for Unlimited Access';
          upgradeBtn.onclick = () => {
            console.log("[Widget] Upgrade button clicked, opening:", error.upgradeUrl);
            window.open(error.upgradeUrl, '_blank');
          };
          errorDiv.appendChild(upgradeBtn);
          
          // Add a note below the button
          const noteDiv = document.createElement('p');
          noteDiv.style.marginTop = '16px';
          noteDiv.style.color = 'var(--text-muted)';
          noteDiv.style.fontSize = '0.85rem';
          noteDiv.textContent = 'Get unlimited access to all AlgoTutor modes!';
          errorDiv.appendChild(noteDiv);
        } else {
          console.warn("[Widget] ‚ö†Ô∏è No upgradeUrl in error object");
        }
        
        outputContainer.appendChild(errorDiv);
        console.log("[Widget] ‚úÖ Error rendered with upgrade container");
      }

      // Listen for state updates from ChatGPT
      window.addEventListener("openai:set_globals", (ev) => {
        console.log("[Widget] ==================== openai:set_globals ====================");
        console.log("[Widget] Event detail:", JSON.stringify(ev.detail, null, 2));
        
        const detail = ev.detail || {};
        const g = detail.globals || detail.state || detail;
        console.log("[Widget] Extracted globals:", JSON.stringify(g, null, 2));
        
        // Check for errors first (including upgrade prompts)
        // Try multiple possible locations
        console.log("[Widget] Checking for errors...");
        let error = extractError(g);
        if (!error && g?.toolOutput) {
          error = extractError(g.toolOutput);
        }
        if (!error && g?.toolOutput?.text) {
          error = extractError(g.toolOutput.text);
        }
        if (!error && g?.content?.[0]?.text) {
          error = extractError(g.content[0].text);
        }
        
        if (error) {
          console.log("[Widget] ‚ö†Ô∏è Found error in response:", error);
          renderError(error);
          return;
        }
        
        // Try to extract outputs from various locations
        let outputs = null;
        
        // Try toolOutput first
        outputs = extractOutputs(g?.toolOutput);
        
        // Try toolOutput.text (MCP format - JSON string)
        if (!outputs && g?.toolOutput?.text) {
          console.log("[Widget] Trying to parse toolOutput.text as JSON");
          outputs = extractOutputs(g.toolOutput.text);
        }
        
        // Try content[0].text (MCP format)
        if (!outputs && g?.content?.[0]?.text) {
          console.log("[Widget] Trying to parse content[0].text as JSON");
          outputs = extractOutputs(g.content[0].text);
        }
        
        // Try widget.props.text
        if (!outputs && g?.widget?.props?.text) {
          console.log("[Widget] Trying to parse widget.props.text as JSON");
          outputs = extractOutputs(g.widget.props.text);
        }
        
        // Try widgetState
        if (!outputs) {
          outputs = extractOutputs(g?.widgetState);
        }
        
        if (outputs) {
          console.log("[Widget] ‚úÖ Found outputs, rendering:", JSON.stringify(outputs, null, 2));
          currentState = { outputs };
          renderOutputs(outputs);
        } else {
          console.warn("[Widget] ‚ùå No outputs found in any location");
        }
      });

      window.addEventListener("openai:state_updated", (ev) => {
        console.log("[Widget] ==================== openai:state_updated ====================");
        console.log("[Widget] Event detail:", JSON.stringify(ev.detail, null, 2));
        
        const s = ev.detail?.state || ev.detail;
        if (!s) {
          console.warn("[Widget] No state in event detail");
          return;
        }
        
        // Check for errors first (including upgrade prompts)
        console.log("[Widget] Checking for errors in state_updated...");
        let error = extractError(s);
        if (!error && s.toolOutput) error = extractError(s.toolOutput);
        if (!error && s.toolOutput?.text) error = extractError(s.toolOutput.text);
        if (!error && s.content?.[0]?.text) error = extractError(s.content[0].text);
        if (error) {
          console.log("[Widget] ‚ö†Ô∏è Found error in state_updated:", error);
          renderError(error);
          return;
        }
        
        // Try to extract outputs from various locations
        let outputs = extractOutputs(s);
        
        if (!outputs) {
          outputs = extractOutputs(s.toolOutput);
        }
        
        if (!outputs && s.toolOutput?.text) {
          outputs = extractOutputs(s.toolOutput.text);
        }
        
        if (!outputs && s.content?.[0]?.text) {
          outputs = extractOutputs(s.content[0].text);
        }
        
        if (outputs) {
          console.log("[Widget] ‚úÖ Rendering outputs from state_updated:", JSON.stringify(outputs, null, 2));
          currentState = { outputs };
          renderOutputs(outputs);
        } else {
          console.warn("[Widget] ‚ùå No outputs found in state");
        }
      });

      // Initial render
      console.log("[Widget] ==================== INITIAL RENDER ====================");
      console.log("[Widget] currentState:", JSON.stringify(currentState, null, 2));
      console.log("[Widget] currentState.outputs exists?", !!currentState.outputs);
      
      if (currentState.outputs) {
        console.log("[Widget] üéØ Calling renderOutputs with initial state");
        renderOutputs(currentState.outputs);
      } else {
        console.warn("[Widget] ‚ö†Ô∏è No initial outputs found - not calling renderOutputs");
      }
      
      console.log("[Widget] ==================== INITIALIZATION COMPLETE ====================");

      // ==================== AUTO-ACTIVATE PREMIUM FROM LOCALSTORAGE ====================
      // Check if user has a stored premium code and auto-activate it for this session
      const storedPremiumCode = localStorage.getItem('algotutor_premium_code');
      const cancelBtn = document.getElementById('cancel-subscription-btn');
      const currentWidgetId = getChatGPTUserId(); // Get widget ID for device binding
      
      if (storedPremiumCode) {
        console.log('[Widget] Found stored premium code, auto-activating:', storedPremiumCode, 'widgetId:', currentWidgetId);
        
        // Show cancel button since user has a stored code
        if (cancelBtn) {
          cancelBtn.style.display = 'inline-block';
        }
        
        // Auto-activate in background (don't block UI)
        // Include widgetId to verify this device is the one that claimed the code
        fetch('https://algo-tutor.org/api/activate-premium', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: storedPremiumCode, widgetId: currentWidgetId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.log('[Widget] Auto-activation failed:', data.error);
            // If code is invalid, revoked, or claimed by another device, remove it from storage
            if (data.error.includes('Invalid') || data.error.includes('not found') || data.error.includes('revoked') || data.error.includes('another device')) {
              localStorage.removeItem('algotutor_premium_code');
              console.log('[Widget] Removed invalid/revoked/claimed code from localStorage');
              // Hide cancel button since code is no longer valid
              if (cancelBtn) {
                cancelBtn.style.display = 'none';
              }
            }
          } else {
            console.log('[Widget] ‚úì Auto-activation successful! Premium status restored.');
            // Update the activate button to show premium is active
            const activateBtn = document.getElementById('activate-premium-btn');
            if (activateBtn) {
              activateBtn.textContent = '‚úì Premium Active';
              activateBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
              activateBtn.disabled = true;
            }
          }
        })
        .catch(error => {
          console.error('[Widget] Auto-activation error:', error);
        });
      } else {
        console.log('[Widget] No stored premium code found');
        // Hide cancel button if no code stored
        if (cancelBtn) {
          cancelBtn.style.display = 'none';
        }
      }
      
      // Cancel subscription button click handler
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          console.log('[Widget] Opening cancel subscription page');
          window.open('https://algo-tutor.org/cancel.html', '_blank');
        });
      }

      // ==================== CHECK COOLDOWN FROM LOCALSTORAGE ====================
      // If user has an active cooldown from a previous session, show it
      const storedCooldown = localStorage.getItem('algotutor_cooldown_expires');
      if (storedCooldown && !storedPremiumCode) {
        const now = Date.now();
        const expires = new Date(storedCooldown).getTime();
        const remaining = expires - now;
        
        if (remaining > 0) {
          console.log('[Widget] Active cooldown found, expires at:', storedCooldown);
          // Don't show cooldown UI on init - it will show when user tries to use the tool
          // Just log that we have an active cooldown
        } else {
          // Cooldown expired, clean up localStorage
          localStorage.removeItem('algotutor_cooldown_expires');
          console.log('[Widget] Cooldown expired, removed from localStorage');
        }
      }

      // ==================== PREMIUM ACTIVATION MODAL ====================
      const premiumModal = document.getElementById('premium-modal');
      const activatePremiumBtn = document.getElementById('activate-premium-btn');
      const modalCancel = document.getElementById('modal-cancel');
      const modalActivate = document.getElementById('modal-activate');
      const premiumCodeInput = document.getElementById('premium-code-input');
      const modalMessage = document.getElementById('modal-message');

      // Open modal
      activatePremiumBtn.addEventListener('click', () => {
        premiumModal.classList.add('active');
        premiumCodeInput.value = '';
        modalMessage.style.display = 'none';
        premiumCodeInput.focus();
      });

      // Close modal
      modalCancel.addEventListener('click', () => {
        premiumModal.classList.remove('active');
      });

      // Close on overlay click
      premiumModal.addEventListener('click', (e) => {
        if (e.target === premiumModal) {
          premiumModal.classList.remove('active');
        }
      });

      // ==================== HELP MODAL ====================
      const helpModal = document.getElementById('help-modal');
      const helpBtn = document.getElementById('help-btn');
      const helpModalClose = document.getElementById('help-modal-close');

      // Open help modal
      helpBtn.addEventListener('click', () => {
        helpModal.classList.add('active');
      });

      // Close help modal
      helpModalClose.addEventListener('click', () => {
        helpModal.classList.remove('active');
      });

      // Close on overlay click
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) {
          helpModal.classList.remove('active');
        }
      });

      // Format input as user types
      premiumCodeInput.addEventListener('input', (e) => {
        let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
        // Auto-add ALGO- prefix if not present
        if (value.length > 0 && !value.startsWith('ALGO-') && !value.startsWith('A')) {
          value = 'ALGO-' + value;
        }
        e.target.value = value;
      });

      // Helper to get chatgpt user ID (from context or generate one based on session)
      function getChatGPTUserId() {
        // Try to get from OpenAI context
        const openaiContext = window.openai || {};
        if (openaiContext.userId) return openaiContext.userId;
        if (openaiContext.subject) return openaiContext.subject;
        
        // Fallback: generate/get from localStorage
        let storedId = localStorage.getItem('algotutor_user_id');
        if (!storedId) {
          storedId = 'widget-' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('algotutor_user_id', storedId);
        }
        return storedId;
      }

      // ==================== REGISTER SESSION FOR FREE TIER TRACKING ====================
      // Register this widget session with the server so usage can be tracked across IP changes
      // This runs on every widget load to keep the session linked
      (async function registerSession() {
        const widgetId = getChatGPTUserId();
        console.log('[Widget] Registering session with widget ID:', widgetId);
        
        try {
          const response = await fetch('https://algo-tutor.org/api/register-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ widgetId })
          });
          
          const data = await response.json();
          if (data.success) {
            console.log('[Widget] ‚úì Session registered successfully');
          } else {
            console.log('[Widget] Session registration response:', data);
          }
        } catch (error) {
          console.error('[Widget] Session registration error:', error);
          // Non-critical error - don't block widget functionality
        }
      })();

      // Activate premium
      modalActivate.addEventListener('click', async () => {
        const code = premiumCodeInput.value.trim().toUpperCase();
        
        if (!code || code.length < 5) {
          modalMessage.textContent = 'Please enter a valid activation code.';
          modalMessage.className = 'modal-message error';
          modalMessage.style.display = 'block';
          return;
        }

        modalActivate.disabled = true;
        modalActivate.textContent = 'Activating...';

        try {
          // Get widget ID for device binding - this binds the code to this specific device
          const widgetId = getChatGPTUserId();
          console.log('[Widget] Activating premium with widgetId:', widgetId);
          
          const response = await fetch('https://algo-tutor.org/api/activate-premium', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              code: code,
              widgetId: widgetId
            })
          });

          const data = await response.json();

          if (data.error) {
            modalMessage.textContent = data.error;
            modalMessage.className = 'modal-message error';
            modalMessage.style.display = 'block';
          } else {
            modalMessage.textContent = '‚úì ' + (data.message || 'Premium activated successfully!');
            modalMessage.className = 'modal-message success';
            modalMessage.style.display = 'block';
            
            // Store the code in localStorage for cross-session persistence
            localStorage.setItem('algotutor_premium_code', code);
            console.log('[Widget] Premium code stored in localStorage:', code);
            
            // Show cancel button now that user has activated premium
            const cancelBtn = document.getElementById('cancel-subscription-btn');
            if (cancelBtn) {
              cancelBtn.style.display = 'inline-block';
            }
            
            // Close modal after brief delay
            setTimeout(() => {
              premiumModal.classList.remove('active');
              
              // Update the activate button to show premium is active
              activatePremiumBtn.textContent = '‚úì Premium Active';
              activatePremiumBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
              activatePremiumBtn.disabled = true;
              
              // Clear any error display and show success state in the output container
              outputContainer.innerHTML = `
                <div class="premium-success-container">
                  <div class="premium-success-icon">üéâ</div>
                  <div class="premium-success-title">Premium Activated!</div>
                  <div class="premium-success-message">
                    Your account now has unlimited access to all AlgoTutor modes.
                  </div>
                  <div class="premium-success-hint">
                    üí° Type a new message in ChatGPT to start learning with premium access!
                  </div>
                  <div class="premium-success-hint" style="margin-top: 12px; background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                    üìä Forgot your code? Visit <strong>algo-tutor.org</strong> and sign in to recover it anytime.
                  </div>
                </div>
              `;
            }, 1500);
          }
        } catch (error) {
          console.error('Activation error:', error);
          modalMessage.textContent = 'Failed to activate. Please try again.';
          modalMessage.className = 'modal-message error';
          modalMessage.style.display = 'block';
        }

        modalActivate.disabled = false;
        modalActivate.textContent = 'Activate';
      });

      // Handle Enter key in input
      premiumCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          modalActivate.click();
        }
      });
    </script>
  </body>
</html>

