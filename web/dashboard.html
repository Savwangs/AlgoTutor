<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AlgoTutor</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-card: #1a1f2e;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.3);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #2d3748;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: -1;
    }

    /* Navigation */
    nav {
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .logo span {
      color: var(--text-primary);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
      font-family: inherit;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      display: inline-block;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-large {
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
    }

    /* Main Content */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Guide Card */
    .guide-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .guide-card h1 {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    /* Steps */
    .steps {
      margin-bottom: 2rem;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--border);
    }

    .step:last-child {
      border-bottom: none;
    }

    .step-number {
      width: 32px;
      height: 32px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .step p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .step p strong {
      color: var(--text-primary);
    }

    .guide-card .btn-primary {
      display: block;
      text-align: center;
      margin-top: 1rem;
    }

    /* Info Card */
    .info-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .info-card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .info-card p {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .info-card a {
      color: var(--accent);
      text-decoration: none;
    }

    .info-card a:hover {
      text-decoration: underline;
    }

    /* Tiers Grid */
    .tiers-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .tier-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .tier-box h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }

    .tier-box p {
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .tier-box.premium {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    }

    .tier-box.premium h3 {
      color: var(--accent);
    }

    /* Section spacing */
    .info-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .info-section:first-of-type {
      margin-top: 0;
      padding-top: 0;
    }

    /* Code Recovery */
    .recovery-form {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .recovery-form input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.875rem;
    }

    .recovery-form input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .recovery-form button {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
    }

    .recovery-form button:hover {
      background: #2563eb;
    }

    .recovery-form button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .recovery-result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }

    .recovery-result.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      display: block;
    }

    .recovery-result.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
      display: block;
    }

    .code-display {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success);
      letter-spacing: 0.1em;
      margin: 0.5rem 0;
    }

    .code-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      border-top: none;
    }

    /* Subscription Status Card */
    .subscription-status {
      margin-top: 1.5rem;
      padding: 1.25rem;
      border-radius: 12px;
      display: none;
    }

    .subscription-status.visible {
      display: block;
    }

    .subscription-status.premium {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
    }

    .subscription-status.cancelled {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
    }

    .subscription-status h3 {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .subscription-status.premium h3 {
      color: var(--success);
    }

    .subscription-status.cancelled h3 {
      color: var(--warning);
    }

    .subscription-status .status-date {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0.5rem 0;
    }

    .subscription-status p {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Cancellation Notice - kept for backwards compatibility */
    .cancellation-notice {
      margin-top: 1.5rem;
      padding: 1.25rem;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      border-radius: 12px;
      display: none;
    }

    .cancellation-notice.visible {
      display: block;
    }

    .cancellation-notice h3 {
      font-size: 0.9rem;
      color: var(--warning);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .cancellation-notice .cancel-date {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0.5rem 0;
    }

    .cancellation-notice p {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      nav {
        padding: 1rem;
      }

      .container {
        padding: 1rem;
      }

      .tiers-grid {
        grid-template-columns: 1fr;
      }

      .guide-card h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <nav>
    <div class="logo">üöÄ Algo<span>Tutor</span></div>
    <div class="nav-right">
      <div class="avatar" id="user-avatar">?</div>
      <button class="btn btn-ghost" id="logout-btn">Sign Out</button>
    </div>
  </nav>

  <main class="container" id="main-content">
    <div class="loading">
      <div class="spinner"></div>
    </div>
  </main>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://tlingzzbcnpekhztapmf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsaW5nenpiY25wZWtoenRhcG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NDc2MTAsImV4cCI6MjA4MjIyMzYxMH0.IkfAgRzwMLyZgMPq4HxKoegnuOkTuzJIF1LA1Ps2TXA';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const mainContent = document.getElementById('main-content');
    const userAvatar = document.getElementById('user-avatar');
    const logoutBtn = document.getElementById('logout-btn');

    async function loadDashboard() {
      if (!supabaseClient) {
        mainContent.innerHTML = `
          <div class="guide-card">
            <h1>Welcome to AlgoTutor!</h1>
            <p style="color: var(--warning); text-align: center;">Supabase not configured.</p>
          </div>
        `;
        return;
      }

      // Check authentication (getUser validates with server)
      const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
      
      if (authError || !user) {
        window.location.href = '/login.html';
        return;
      }

      const name = user.user_metadata?.full_name || user.email.split('@')[0];
      const initial = name.charAt(0).toUpperCase();
      userAvatar.textContent = initial;

      mainContent.innerHTML = `
        <!-- Getting Started Guide -->
        <div class="guide-card">
          <h1>How to Use AlgoTutor</h1>
          
          <div class="steps">
            <div class="step">
              <span class="step-number">1</span>
              <p>Click the "Open ChatGPT" button below Step 8</p>
            </div>
            <div class="step">
              <span class="step-number">2</span>
              <p>Click your <strong>profile picture</strong> (bottom left)</p>
            </div>
            <div class="step">
              <span class="step-number">3</span>
              <p>Click <strong>Settings</strong></p>
            </div>
            <div class="step">
              <span class="step-number">4</span>
              <p>Click <strong>Apps</strong> in the sidebar</p>
            </div>
            <div class="step">
              <span class="step-number">5</span>
              <p>Click <strong>"Add more apps"</strong></p>
            </div>
            <div class="step">
              <span class="step-number">6</span>
              <p>Search <strong>"AlgoTutor"</strong> and add it</p>
            </div>
            <div class="step">
              <span class="step-number">7</span>
              <p>Start a new chat and click the "+" button and under "More" select "AlgoTutor"</p>
            </div>
            <div class="step">
              <span class="step-number">8</span>
              <p> Ask about any DSA topic or help with a coding problem! </p>
            </div>
          </div>
          
          <a href="https://chat.openai.com" target="_blank" class="btn btn-primary btn-large">
            Open ChatGPT
          </a>
        </div>

        <!-- Free vs Premium -->
        <div class="info-card">
          <h2>Free vs Premium</h2>
          <div class="tiers-grid">
            <div class="tier-box">
              <h3>Free</h3>
              <p>3 requests per day</p>
              <p>All modes (Learn, Build, Debug)</p>
            </div>
            <div class="tier-box premium">
              <h3>Premium ‚Äî $9.99/mo</h3>
              <p>Unlimited requests</p>
              <p>All modes (Learn, Build, Debug)</p>
            </div>
          </div>
          
          <!-- Subscription Status - shown for premium users -->
          <div class="subscription-status" id="subscription-status">
            <h3 id="status-title">Loading...</h3>
            <div class="status-date" id="status-date"></div>
            <p id="status-description"></p>
          </div>
        </div>

        <!-- Premium & Cancellation Info -->
        <div class="info-card">
          <div class="info-section">
            <h2>Activating Premium</h2>
            <p>After purchasing Premium, you'll receive a unique code. In ChatGPT, open the AlgoTutor widget and click <strong>"Activate Premium"</strong>. Enter your code and your premium access activates instantly.</p>
          </div>
          
          <div class="info-section">
            <h2>Cancelling Your Subscription</h2>
            <p>To cancel your subscription, click the "Cancel Subscription" button at the top right of the AlgoTutor widget in ChatGPT and follow the instructions from there. Your premium access continues until the end of your current billing period. </p>
          </div>
        </div>

        <!-- Code Recovery -->
        <div class="info-card">
          <h2>Recover Your Premium Code</h2>
          <p>Lost your activation code or using a different browser? Enter the email you used to purchase Premium and we'll retrieve your code.</p>
          
          <div class="recovery-form">
            <input type="email" id="recovery-email" placeholder="your@email.com" value="${user.email || ''}">
            <button id="recovery-btn">Lookup Code</button>
          </div>
          
          <div class="recovery-result" id="recovery-result"></div>
          
          <!-- Cancellation Notice - only shown if subscription is cancelled but still active -->
          <div class="cancellation-notice" id="cancellation-notice">
            <h3>‚ö†Ô∏è Subscription Ending</h3>
            <div class="cancel-date" id="cancel-date"></div>
            <p>Your premium access will end on this date. You will not be charged again.</p>
          </div>
        </div>
      `;

      // Fetch subscription status from API
      try {
        const response = await fetch('/api/subscription-status?email=' + encodeURIComponent(user.email));
        const subData = await response.json();
        
        console.log('[Dashboard] Subscription status:', subData);
        
        const statusCard = document.getElementById('subscription-status');
        const statusTitle = document.getElementById('status-title');
        const statusDate = document.getElementById('status-date');
        const statusDescription = document.getElementById('status-description');
        
        if (!subData.error && statusCard) {
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          
          if (subData.tier === 'premium') {
            if (subData.cancelAt) {
              // Cancelled but still has access
              const cancelDate = new Date(subData.cancelAt * 1000);
              const now = new Date();
              
              if (cancelDate > now) {
                statusCard.className = 'subscription-status cancelled visible';
                statusTitle.textContent = '‚ö†Ô∏è Subscription Ending';
                statusDate.textContent = cancelDate.toLocaleDateString('en-US', options);
                statusDescription.textContent = 'Your premium access will end on this date. You will not be charged again.';
              }
            } else if (subData.nextBillingDate) {
              // Active premium subscription
              const billingDate = new Date(subData.nextBillingDate * 1000);
              statusCard.className = 'subscription-status premium visible';
              statusTitle.textContent = '‚úì Premium Active';
              statusDate.textContent = 'Next billing: ' + billingDate.toLocaleDateString('en-US', options);
              statusDescription.textContent = 'Your subscription will automatically renew on this date.';
            } else {
              // Premium but no billing info available
              statusCard.className = 'subscription-status premium visible';
              statusTitle.textContent = '‚úì Premium Active';
              statusDate.textContent = '';
              statusDescription.textContent = 'You have unlimited access to all AlgoTutor modes.';
            }
          }
        }
      } catch (error) {
        console.error('[Dashboard] Error fetching subscription status:', error);
      }

      // Setup code recovery handler
      const recoveryBtn = document.getElementById('recovery-btn');
      const recoveryEmail = document.getElementById('recovery-email');
      const recoveryResult = document.getElementById('recovery-result');

      recoveryBtn.addEventListener('click', async () => {
        const email = recoveryEmail.value.trim();
        
        if (!email) {
          recoveryResult.innerHTML = 'Please enter an email address.';
          recoveryResult.className = 'recovery-result error';
          return;
        }

        recoveryBtn.disabled = true;
        recoveryBtn.textContent = 'Looking up...';

        try {
          const response = await fetch('/api/lookup-code?email=' + encodeURIComponent(email));
          const data = await response.json();

          if (data.error) {
            recoveryResult.innerHTML = data.error;
            recoveryResult.className = 'recovery-result error';
          } else {
            recoveryResult.innerHTML = '<div>Your Premium Activation Code:</div>' +
              '<div class="code-display">' + data.code + '</div>' +
              '<div class="code-hint">Copy this code and enter it in the AlgoTutor widget in ChatGPT.</div>';
            recoveryResult.className = 'recovery-result success';
          }
        } catch (error) {
          console.error('Lookup error:', error);
          recoveryResult.innerHTML = 'Failed to lookup code. Please try again.';
          recoveryResult.className = 'recovery-result error';
        }

        recoveryBtn.disabled = false;
        recoveryBtn.textContent = 'Lookup Code';
      });

      // Allow Enter key to trigger lookup
      recoveryEmail.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          recoveryBtn.click();
        }
      });
    }

    // Logout
    logoutBtn.addEventListener('click', async () => {
      if (supabaseClient) {
        await supabaseClient.auth.signOut();
      }
      window.location.href = '/login.html';
    });

    // Load dashboard
    loadDashboard();
  </script>

  <!-- Footer -->
  <footer style="text-align: center; padding: 2rem; border-top: 1px solid var(--border); margin-top: 2rem;">
    <p style="color: var(--text-secondary); font-size: 0.875rem;">
      Need help? Contact us at 
      <a href="mailto:support@algo-tutor.org" style="color: var(--accent); text-decoration: none;">support@algo-tutor.org</a>
    </p>
  </footer>
</body>
</html>
